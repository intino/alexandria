<link rel="import" href="../../../../lib/polymer/polymer.html">
<link rel="import" href="../../../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../../../../lib/google-map/google-map.html">
<link rel="import" href="../../../../lib/google-map-markerclusterer/google-map-markercluster.html">
<link rel="import" href="alexandria-catalog-map-item.html">
<link rel="import" href="alexandria-catalog-toolbar.html">

<dom-module id="alexandria-catalog-map">

    <template>
        <!--<google-map-markerclusterer map="{{map}}"></google-map-markerclusterer>-->
        <google-map map="{{map}}"
                    additional-map-options="[[_options]]"
                    latitude="[[center.latitude]]"
                    longitude="[[center.longitude]]"
                    min-zoom="[[zoom.min]]"
                    zoom="[[zoom.defaultValue]]"
                    max-zoom="[[zoom.max]]"
                    api-key="[[googleApiKey]]"
                    fit-to-markers="true"
                    disable-street-view-control="true"></google-map>
        <alexandria-catalog-toolbar operations="[[_operations(toolbar)]]"
                                    on-execute="_executeOperation"
                                    on-download="_downloadOperation"></alexandria-catalog-toolbar>
        <template is="dom-repeat" items="{{_itemList}}">
            <alexandria-catalog-map-item mode="map" map="{{map}}" mold="[[mold]]" item="[[item]]"></alexandria-catalog-map-item>
        </template>
    </template>

    <style>
        :host alexandria-catalog-toolbar {
            position: absolute;
            top: 0;
            right: 0;
            margin-top: 10px;
            margin-right: 10px;
            z-index: 1;
            background: white;
            border-radius: 10px;
            padding: 0 10px;
        }
    </style>

    <script>
        const AlexandriaCatalogMapDictionary = {
            es: {
            },
            en: {
            }
        };

        Polymer({
            is: 'alexandria-catalog-map',

            properties: {
                map : Object,
                center: Object,
                zoom: Object,
                mold: Object,
                itemList: { type: Array, observer: '_refresh', value: function() { return []; } },
                _itemList: { type: Array, value: function() { return []; } },
                countItemList: Number,
                toolbar: Object,
                _options : { type: Object, value: function() { return {}; } }
            },

            behaviors: [ CottonBehaviors.TranslatorBehavior ],

            attached: function () {
                this.translate(AlexandriaCatalogMapDictionary);
                this._addListeners();
            },

            clear : function() {
                let mapItems = this.querySelectorAll("alexandria-catalog-map-item");
                mapItems.forEach((item) => item.setMap(null));
                this.notifyPath("_itemList", []);
            },

            refreshItem : function(item) {
            },

            closeInfoWindows : function() {
                let mapItems = this.querySelectorAll("alexandria-catalog-map-item");
                mapItems.forEach((item) => item.closeInfoWindow());
            },

            _addListeners : function() {
                var element = this.querySelector("google-map");
                element.addEventListener('google-map-idle', () => {
                    var bounds = element.map.getBounds();
                    this.fire("location-change", { northEast : bounds.getNorthEast(), southWest : bounds.getSouthWest() });
                });
                element.addEventListener('google-map-ready', (e) => {
                    this._notifyMapReady();
                });
            },

            _refresh : function() {
                if (this._refreshTimeout != null)
                    window.clearTimeout(this._refreshTimeout);

                var map = this.querySelector("google-map").map;

                if (map != null)
                    map.closeInfoWindows = () => this.closeInfoWindows();

                for (var i=0; i<this.itemList.length; i++)
                    this.push("_itemList", this.itemList[i]);

                this._refreshTimeout = window.setTimeout(() => this.querySelectorAll("alexandria-catalog-map-item").forEach((item) => item.setMap(map)), 100);
            },

            _notifyMapReady : function() {
                this._refresh();
            },

            _executeOperation : function(e) {
                this.fire("execute-operation", e.detail);
            },

            _downloadOperation : function(e) {
                this.fire("download-operation", e.detail);
            },

            _operations : function(toolbar) {
                var result = [];
                if (toolbar == null) return result;
                var operationList = toolbar.operationList;
                for (var i=0; i<operationList.length; i++) {
                    if (operationList[i].when != "Always") continue;
                    result.push(operationList[i]);
                }
                return result;
            }

        });
    </script>

</dom-module>
