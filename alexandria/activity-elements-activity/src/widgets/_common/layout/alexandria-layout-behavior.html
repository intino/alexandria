<script>
    'use strict';

    var AlexandriaBehaviors = AlexandriaBehaviors || {};

    AlexandriaBehaviors.LayoutBehavior = {

        Dictionary : {
            es: {
                NoItemsMessage: 'no se ha definido ningÃºn elemento'
            },
            en: {
                NoItemsMessage: 'no elements defined'
            }
        },

        _layoutLoadedTimer: null,

        properties : {
            _itemList: { type: Array, observer: '_itemsLoaded' },
            _itemTabList: Array,
            _selectedItem : { type: String, observer: '_selectItemByLabel' },
            _selectedItemIndex: Number,
            _title : String,
            _subtitle : String,
            _logo : String,
            _authServiceUrl : String
        },

        _loading : function() {
            this.$.layout.loading = true;
            if (this._layoutLoadedTimer != null) window.clearTimeout(this._loadedTimer);
        },

        _loaded : function() {
            this._layoutLoadedTimer = window.setTimeout(() => this.$.layout.loading = false, 800);
        },

        _refreshItemList : function(itemList) {
            const countItems = itemList.length;
            itemList.forEach((item) => item.type = this._itemProperty(item, "type").value);
            this._itemList = itemList;
            this._itemTabList = countItems > 0 ? this._arrayOf(itemList) : ['noItems'];
            this._loadDefaultItem(itemList);
        },

        _itemProperty : function(item, property) {
            let properties = item.referencePropertyList;
            for (var i=0; i<properties.length; i++) {
                if (properties[i].name == property)
                    return properties[i];
            }
            return null;
        },

        _selectItemByLabel : function(label) {
            if (this._refreshingSelected) return;
            this._selectItemDelayed(label);
        },

        _selectItemByIndex : function(event) {
            if (this._refreshingSelected) return;
            if (this._itemList == null) return;
            this._selectItemDelayed(event.detail);
        },

        _selectItemDelayed : function(label) {
            if (this._selectItemTimeout != null) window.clearTimeout(this._selectItemTimeout);
            this._selectItemTimeout = window.setTimeout(() => {
                if (label == "noItems") return;
            if (this._selectedItemIndex == this._indexOf(label)) return;
            this.selectItem(label);
        }, 100);
        },

        _refreshSelected : function(selected) {
            if (this._selectedItem == selected) return;
            this._refreshingSelected = true;
            this._selectedItem = selected;
            this._selectedItemIndex = this._indexOf(selected);
            this._saveDefaultItem(selected);
            this._refreshingSelected = false;
        },

        _indexOf : function(label) {
            var index = -1;
            for(var i=0; i<this._itemList.length; i++) {
                var item = this._itemList[i];
                if (item.label === label)
                    index = i;
            }
            return index;
        },

        _arrayOf : function(itemList) {
            var result = [];
            for(var i=0; i<itemList.length; i++)
                result.push(itemList[i].label);
            return result;
        },

        _info : function(info) {
            this._title = info.title;
            this._subtitle = info.subtitle;
            this._logo = info.logo;
            this._authServiceUrl = info.authServiceUrl;
        },

        _user : function(user) {
            this.$.layout.user = user;
        },

        _logout: function () {
            this.logout();
        },

        _editProfile: function () {
            if (this._authServiceUrl == null || this._authServiceUrl === "") return;
            window.open(this._authServiceUrl, '_blank');
        },

        _userLoggedOut : function(homeUrl) {
            window.location.href = homeUrl;
        },

        _loadDefaultItem : function(itemList) {
            try {
                var label = Cookies.get("alexandria-layout");
                label = label != null && label !== "" ? label : (itemList.length > 0 ? itemList[0].label : null);
                if (this._indexOf(label) == -1) label = (itemList.length > 0 ? itemList[0].label : null);
                this._selectItemByLabel(label);
            }
            catch(e) {
                return itemList.length > 0 ? itemList[0].label : null;
            }
        },

        _saveDefaultItem : function(label) {
            try {
                Cookies.set("alexandria-layout", label, 30);
            }
            catch (exception) {
            }
        }

    };

</script>