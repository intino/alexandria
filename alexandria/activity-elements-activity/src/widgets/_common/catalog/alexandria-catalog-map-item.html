<link rel="import" href="../../../../lib/polymer/polymer.html">
<link rel="import" href="../../../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../mold/alexandria-mold-block.html">
<link rel="import" href="../mold/alexandria-mold-behavior.html">

<script src="../../../../lib/wicket/wicket.js"></script>
<script src="../../../../lib/wicket/wicket-gmap3.js"></script>

<dom-module id="alexandria-catalog-map-item">

    <template>
        <div class="info-template">
            <div class="alexandria-catalog-map-item-0">
                <template id="infoWindowTemplate" is="dom-repeat" items="[[_blocks]]" as="block">
                    <div class="alexandria-mold-block-0">
                        <alexandria-mold-block mode="map" item="[[item.name]]" block="[[block]]" on-stamps-ready="_stampsReady"></alexandria-mold-block>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <style>
        :host .block > * {
            margin-left: 5px;
        }
        :host .info-template {
            display: none;
        }
        :host .picture img {
            width: 300px;
            height: 200px;
        }
    </style>

    <script>
        const AlexandriaCatalogMapItemDictionary = {
            es: {
            },
            en: {
            }
        };

        Polymer({
            is: 'alexandria-catalog-map-item',

            behaviors: [
                CottonBehaviors.TranslatorBehavior,
                AlexandriaBehaviors.MoldBehavior ],

            properties : {
                map : Object,
                centroid : { type: Object, value: function() { return { latitude: 0, longitude: 0 }; } },
                infoWindow : { type: Object, value: function() { return null; }},
                locationItem : { type: Object, value: function() { return null; }},
                countReadyBlocks : { type: Number, value: function() { return 0; }}
            },

            attached: function () {
                this.translate(AlexandriaCatalogMapItemDictionary);
                this.countReadyBlocks = 0;
            },

            detached : function() {
                this.setMap(null);
            },

            setMap : function(map) {
                this.map = map;

                if (map == null) {
                    this._setMapToItem(null);
                    return;
                }

                this._createInfoWindow();
                this._onRefresh();
            },

            marker : function() {
                return this.locationItem;
            },

            openInfoWindow : function() {
                this.map.closeInfoWindows();
                this.infoWindow.open(this.map, this.locationItem);
                this.infoWindow.opened = true;
            },

            closeInfoWindow : function() {
                if (this.infoWindow == null || !this._isInfoWindowOpened()) return;
                this.infoWindow.close();
                this.infoWindow.opened = false;
            },

            _stampsReady : function() {
                this.countReadyBlocks++;
                if (this.countReadyBlocks < this._blocks.length) return;
                this.countReadyBlocks = 0;
                this._createInfoWindow();
            },

            _createInfoWindow : function() {
                if (this.infoWindow != null) return;
                if (this.map == null) return;
                var widget = this;
                window.setTimeout(function() {
                    widget.infoWindow = new google.maps.InfoWindow({
                        content: widget._infoContent()
                    });
                }, 50);
            },

            _infoContent : function() {
                var content = this.querySelector(".info-template").innerHTML;
                content = content.replace(/<template[^<\/]*<\/template>/g, "");
                content = content.replace(/<alexandria-mold-block/g, "<div");
                content = content.replace(/<\/alexandria-mold-block>/g, "</div>");
                return content;
            },

            _onRefresh : function() {
                if (this.map == null) return;
                var stampList = this._locationStampList();
                for (var i=0; i<stampList.length; i++)
                    this._addLocation(stampList[i]);
            },

            _addLocation : function(locationStamp) {
                if (locationStamp == null || locationStamp.value == "") return;

                var wkt = new Wkt.Wkt();
                try {
                    wkt.read(locationStamp.value);
                    this.locationItem = wkt.toObject(this._configuration(locationStamp));
                    this._addIcon(locationStamp.properties.icon);
                    this._addListeners(this.locationItem);
//                    this._updateCentroid(this.locationItem);
//                    if (this._isMarker(this.locationItem)) return;
                    this._setMapToItem(this.map);
                } catch (e1) {
                    if (e1.name === 'WKTError') {
                        return;
                    }
                }
            },

            _configuration : function(stamp) {
                var config = this.map.defaults != null ? this.map.defaults : {};
                var drawingColor = stamp.properties.drawingColor;
                config.editable = stamp.isEditable != null ? stamp.isEditable : false;
                if (drawingColor != "") {
                    config.strokeColor = drawingColor;
                    config.fillColor = drawingColor;
                }
                return config;
            },

            _setMapToItem : function(map) {
                if (this.locationItem == null) return;
                if (Wkt.isArray(this.locationItem)) {
                    for (var i=0; i<this.locationItem.length; i++)
                        this.locationItem[i].setMap(map);
                } else {
                    this.locationItem.setMap(map);
                }
            },

            _isMarker : function(obj) {
                return (obj instanceof google.maps.Marker);
            },

            _addIcon : function(icon) {
                if (icon == null || icon == "") return;
                this.locationItem.setIcon(icon);
            },

            _addListeners : function() {
                this.locationItem.addListener('click', () => {
                    if (this._isInfoWindowOpened()) this.closeInfoWindow();
            else this.openInfoWindow();
            });
            },

            _isInfoWindowOpened : function() {
                return this.infoWindow.opened;
            },

            _updateCentroid : function(obj) {
                if (this._isMarker(obj)) {
                    this.notifyPath("centroid.latitude", obj.position.lat());
                    this.notifyPath("centroid.longitude", obj.position.lng());
                }
            }

        });
    </script>

</dom-module>
