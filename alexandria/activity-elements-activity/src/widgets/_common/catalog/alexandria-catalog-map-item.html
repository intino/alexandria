<link rel="import" href="../../../../lib/polymer/polymer.html">
<link rel="import" href="../../../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../mold/alexandria-mold-block.html">
<link rel="import" href="../mold/alexandria-mold-behavior.html">

<script src="../../../../lib/wicket/wicket.js"></script>
<script src="../../../../lib/wicket/wicket-gmap3.js"></script>

<dom-module id="alexandria-catalog-map-item">

    <template>
        <div class="info-template">
            <div class="alexandria-catalog-map-item-0">
                <div id="infoWindowTemplate">[[Loading]]</div>
            </div>
        </div>
    </template>

    <style>
        :host .block > * {
            margin-left: 5px;
        }
        :host .info-template {
            display: none;
        }
        :host .picture img {
            width: 300px;
            height: 200px;
        }
    </style>

    <script>
        const AlexandriaCatalogMapItemDictionary = {
            es: {
                Loading: "cargando..."
            },
            en: {
                Loading: "loading..."
            }
        };

        Polymer({
            is: 'alexandria-catalog-map-item',

            behaviors: [
                CottonBehaviors.TranslatorBehavior,
                AlexandriaBehaviors.MoldBehavior ],

            properties : {
                map : Object,
                centroid : { type: Object, value: function() { return { latitude: 0, longitude: 0 }; } },
                infoWindow : { type: Object, value: function() { return null; }},
                locationItem : { type: Object, value: function() { return null; }},
                loaded : { type: Boolean, value: function() { return false }},
                _moldContainer : Object
            },

            attached: function () {
                this.translate(AlexandriaCatalogMapItemDictionary);
            },

            update : function(item) {
                this.item = item;
                this._prepareInfoWindow();
                this.loaded = true;
            },

            _prepareInfoWindow : function() {
                this._renderMold();
                this._createInfoWindow();
            },

            _renderMold : function() {
                var widget = this;
                var infoWindowTemplate = this.$.infoWindowTemplate;
                infoWindowTemplate.innerHTML = "";

                this._moldContainer = document.createElement("alexandria-mold-container");
                this._moldContainer.mode = this.mode;
                this._moldContainer.item = this.item;
                this._moldContainer.mold = this.mold;
                this._moldContainer.addEventListener("navigate-item", function(e) {
                    widget.fire("navigate-item", e.detail);
                });

                infoWindowTemplate.appendChild(this._moldContainer);
            },

            detached : function() {
                this.setMap(null);
            },

            setMap : function(map) {
                this.map = map;

                if (map == null) {
                    this._setMapToItem(null);
                    return;
                }

                this._createInfoWindow();
                this._onRefresh();
            },

            marker : function() {
                return this.locationItem;
            },

            openInfoWindow : function() {
                this.map.closeInfoWindows();
                this.infoWindow.open(this.map, this.locationItem);
                this.infoWindow.opened = true;
                if (this.onOpen) this.onOpen(this);
            },

            closeInfoWindow : function() {
                if (this.infoWindow == null || !this.isInfoWindowOpened()) return;
                this.infoWindow.close();
                this.infoWindow.opened = false;
                if (this.onClose) this.onClose(this);
            },

            _createInfoWindow : function() {
                if (this.infoWindow != null) return;
                if (this.map == null) return;
                var widget = this;
                window.setTimeout(function() {
                    widget.infoWindow = new google.maps.InfoWindow({
                        content: widget.$.infoWindowTemplate
                    });
                }, 50);
            },

            _onRefresh : function() {
                if (this.map == null || this.item == null) return;
                var stampList = this.item.itemStampList;
                for (var i=0; i<stampList.length; i++)
                    this._addLocation(stampList[i]);
            },


            _addLocation : function(locationStamp) {
                if (locationStamp == null || locationStamp.values.length == 0 || locationStamp.values[0] == "") return;

                var wkt = new Wkt.Wkt();
                try {
                    wkt.read(locationStamp.values[0]);
                    this.locationItem = this._fixWkt(wkt).toObject(this._configuration(locationStamp));
                    if (locationStamp.propertyList.icon)
                        this._addIcon(locationStamp.propertyList.icon);
                    this._addListeners(this.locationItem);
//                    this._updateCentroid(this.locationItem);
//                    if (this._isMarker(this.locationItem)) return;
                    this._setMapToItem(this.map);
                } catch (e1) {
                    if (e1.name === 'WKTError') {
                        return;
                    }
                }
            },

            _fixWkt : function(wkt) {
                for (var i=0; i<wkt.components.length; i++)
                    this._fixWktComponent(wkt.components[i]);
                return wkt;
            },

            _fixWktComponent : function(component) {
                if (component instanceof Array) {
                    for(var i=0; i<component.length; i++) {
                        this._fixWktComponent(component[i]);
                    }
                }
                else {
                    var x = component.x;
                    component.x = component.y;
                    component.y = x;
                }
            },

            _configuration : function(stamp) {
                var config = this.map.defaults != null ? this.map.defaults : {};
                var color = stamp.propertyList.color;
                config.editable = stamp.editable != null ? stamp.editable : false;
                if (color != null) {
                    config.strokeColor = color.text;
                    config.fillColor = color.text;
                }
                return config;
            },

            _setMapToItem : function(map) {
                if (this.locationItem == null) return;
                if (Wkt.isArray(this.locationItem)) {
                    for (var i=0; i<this.locationItem.length; i++)
                        this.locationItem[i].setMap(map);
                } else {
                    this.locationItem.setMap(map);
                }
            },

            _isMarker : function(obj) {
                return (obj instanceof google.maps.Marker);
            },

            _addIcon : function(icon) {
                if (icon == null || icon == "") return;
                this.locationItem.setIcon(icon);
            },

            _addListeners : function() {
                this.locationItem.addListener('click', () => {
                    if (this.isInfoWindowOpened()) this.closeInfoWindow();
                    else {
                        this.openInfoWindow();
                        if (!this.loaded) this.fire("load", this.item.name);
                    }
                });
            },

            isInfoWindowOpened : function() {
                return this.infoWindow.opened;
            },

            _updateCentroid : function(obj) {
                if (this._isMarker(obj)) {
                    this.notifyPath("centroid.latitude", obj.position.lat());
                    this.notifyPath("centroid.longitude", obj.position.lng());
                }
            }

        });
    </script>

</dom-module>
