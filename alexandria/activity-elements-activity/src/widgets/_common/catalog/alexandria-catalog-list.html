<link rel="import" href="../../../../lib/polymer/polymer.html">
<link rel="import" href="../../../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../../../../lib/paper-input/paper-input.html">
<link rel="import" href="../../../../lib/cotton-list/cotton-list.html">
<link rel="import" href="../../../../lib/iron-list/iron-list.html">
<link rel="import" href="../../../../lib/paper-input/paper-input.html">
<link rel="import" href="../../../../lib/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../lib/paper-item/paper-item.html">
<link rel="import" href="../../../../lib/iron-icon/iron-icon.html">
<link rel="import" href="../../../../lib/paper-button/paper-button.html">
<link rel="import" href="../../../../lib/cotton-checkbox/cotton-checkbox.html">
<link rel="import" href="../mold/alexandria-mold.html">
<link rel="import" href="alexandria-catalog-behavior.html">
<link rel="import" href="alexandria-catalog-sorting.html">
<link rel="import" href="alexandria-catalog-cluster-dialog.html">
<link rel="import" href="alexandria-catalog-toolbar.html">
<link rel="import" href="../alexandria-date-behavior.html">

<dom-module id="alexandria-catalog-list">

    <template>
        <div class="toolbar" hidden$="[[_toolbarHidden]]">
            <div class="layout horizontal" hidden$="[[_clusterPanelVisible]]">
                <div class="sorting-box layout horizontal center" hidden$="[[!sortingList.length]]">
                    <div class="label">[[Sortings]]</div>
                    <alexandria-catalog-sorting selected-sorting$="[[selectedSorting]]"
                                                sorting-list="[[sortingList]]"></alexandria-catalog-sorting>
                </div>
                <div class="flex layout horizontal end-justified">
                    <alexandria-catalog-toolbar operations="[[_alwaysOperations(toolbar)]]"
                                                on-execute="_executeOperation"
                                                on-download="_downloadOperation"></alexandria-catalog-toolbar>
                    <div class="search-box flex layout vertical center-justified" hidden$="[[!canSearch]]">
                        <paper-input id="filter" label="[[Search]]" type="text" no-label-float on-keyup="_filter">
                            <iron-icon icon="search" prefix></iron-icon>
                            <paper-icon-button suffix icon="icons:cancel" hidden$="[[!condition]]" on-tap="_clearFilter"></paper-icon-button>
                        </paper-input>

                    </div>
                </div>
            </div>
            <div class="box selected" hidden$="[[!_clusterPanelVisible]]">
                <div class="layout horizontal center center-justified">
                    <paper-icon-button icon="arrow-back" alt="[[RemoveSelection]]" on-tap="_clearSelection"></paper-icon-button>
                    <div class="flex">[[_countSelectedItemList(selectedItemList.length)]]</div>
                    <alexandria-catalog-toolbar operations="[[_selectionOperations(toolbar)]]"
                                                on-execute="_executeOperation"
                                                on-download="_downloadOperation"
                                                on-group="_showClusterDialog"></alexandria-catalog-toolbar>
                </div>
            </div>
        </div>
        <div class$="layout horizontal flex embedded_[[embedded]] full-size_[[_toolbarHidden]]">
            <cotton-list page-size="[[pageSize]]" count="[[countItemList]]" on-new-page="_loadPage" no-items-message="[[_emptyMessage]]" class$="flex [[_classes]]">
                <iron-list id="items" items="[[_itemList]]" multi-selection selected-items="{{selectedItemList}}"
                           as="item" grid="[[grid]]" style$="width:calc([[width]]% - [[_offsetWidth]]px);margin:0 auto;"
                           on-iron-resize="_resize" class$="selection_[[_allowSelection]] selection_enabled_[[_selectionEnabled]]">
                    <template>
                        <div class$="[[_classForItem(item, selected)]]" name$="[[item.name]]" on-tap="_openItem">
                            <div class="group-header" style$="[[item.group.style]]">[[item.group.label]]</div>
                            <div class="content layout horizontal">
                                <template is="dom-if" if="[[!grid]]">
                                    <div class="layout horizontal flex">
                                        <div class="selector"><cotton-checkbox checked$="[[item.checked]]" name$="[[item.name]]" on-change="_toggleSelection" icon="done"></cotton-checkbox></div>
                                        <div class="flex">
                                            <alexandria-mold name$="_item_[[item.name]]"
                                                             item="[[item]]"
                                                             mold="[[mold]]"
                                                             on-open-dialog="_openStampDialog"
                                                             on-execute-task-item="_executeStampTask"></alexandria-mold>
                                        </div>
                                    </div>
                                </template>
                                <template is="dom-if" if="[[grid]]">
                                    <div class="layout horizontal flex">
                                        <div class="selector"><cotton-checkbox checked$="[[item.checked]]" name$="[[item.name]]" on-change="_toggleSelection" icon="done"></cotton-checkbox></div>
                                        <div class="flex">
                                            <alexandria-mold name$="_item_[[item.name]]"
                                                             item="[[item]]"
                                                             mold="[[mold]]"
                                                             mode="grid"
                                                             on-open-dialog="_openStampDialog"
                                                             on-execute-task-item="_executeStampTask"></alexandria-mold>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </iron-list>
            </cotton-list>
        </div>
        <alexandria-catalog-cluster-dialog clusters="[[clusters]]" items="[[selectedItemList]]"></alexandria-catalog-cluster-dialog>
    </template>

    <style>
        :host .toolbar {
            padding: 10px 18px 8px;
        }
        :host .toolbar .search-box {
            border: 1px solid #ddd;
            margin-left: 6px;
            margin-right: 7px;
            position: relative;
            background: #efefef;
        }
        :host .toolbar .search-box:hover {
            background: white;
        }
        :host .toolbar .search-box paper-icon-button {
            margin-top: -4px;
            height: 22px;
            width: 22px;
            color: #888;
            padding: 0;
        }
        :host .toolbar .search-box paper-input {
            margin: 2px 7px 0;
            --paper-input-container : {
                padding: 0;
            };
            --paper-input-container-input : {
                font-size: 10pt;
            };
            --paper-input-container-label : {
                font-size: 10pt;
            };
            --paper-input-container-underline : {
                display: none;
            };
            --paper-input-container-underline-focus : {
                display: none;
            };
        }
        :host .toolbar .search-box paper-input iron-icon {
            color: #888;
        }
        :host .toolbar .sorting-box {
            width: 50%;
            padding: 7px 7px 0;
        }
        :host .toolbar .sorting-box .label {
            color: #888;
            font-size: 9pt;
            margin-right: 10px;
            margin-top: 3px;
        }
        :host .group-header {
            margin: 10px 13px;
            color: #777;
            font-size: 10pt;
        }
        :host .embedded_true .container .content, :host .embedded_true .container.expanded .content {
            padding: 5px 0;
            box-shadow: none;
            border-bottom: 1px dotted #eee;
            min-height: 24px !important;
        }
        :host .full-size_false {
            height: calc(100% - 48px);
        }
        :host .full-size_true {
            height: 100%;
        }
        :host .container .content {
            @apply(--alexandria-catalog-item);
        }
        :host .container .content .selector {
            visibility: hidden;
            opacity: 0;
            transition: visibility 3s, opacity 0.5s linear;
        }
        :host .selection_false .content .selector {
            display: none;
        }
        :host  .selection_true.selection_enabled_true .container .content .selector, :host .selection_true .container .content:hover .selector {
            visibility: visible;
            opacity: 1;
        }
        :host .grid .container .content, :host .grid .container.expanded .content {
            margin: 0 10px 30px;
            padding: 0;
            border: 5px solid transparent;
            height: calc(100% - 40px);
        }
        :host .grid .container.expanded .content {
            border: 5px solid var(--accent-color);
        }
        :host .list .item.expanded .content {
            margin: 0 15px;
            border-left: 10px solid var(--accent-color);
            min-height: 38px;
        }
        :host .embedded_true .list .item.expanded .content {
            border-left: 0;
        }
        :host alexandria-mold {
            width: 100%;
        }
        :host .box.selected {
            border: 2px solid var(--accent-color);
            border-radius: 5px;
        }
        :host .box.selected .flex {
            font-size: 11pt;
        }
        :host .box.selected iron-list {
            height: calc(100% - 50px);
        }
        :host .box.selected iron-list paper-item {
            white-space: nowrap;
            cursor: pointer;
            font-size: 10pt;
            padding: 2px;
            min-height: 34px;
        }
        :host .box.selected iron-list paper-item:hover::after {
            content: "－";
            width: 16px;
            height: 16px;
            display: block;
            border-radius: 50% 50%;
            background-color: var(--google-red-300);
            margin-left: 10px;
            line-height: 16px;
            text-align: center;
            color: white;
            text-decoration: none;
            position: absolute;
            right: 15px;
            top: calc(50% - 8px);
        }
        :host cotton-checkbox {
            position: absolute;
            margin-left: -34px;
            --cotton-checkbox-size : 20px;
        }
        :host .grid cotton-checkbox {
            z-index: 1;
            margin: -14px -16px -16px;
            border-radius: 35px;
            --cotton-checkbox-size : 25px;
        }
        :host .container.expanded .content cotton-checkbox {
            margin-left: -43px;
        }
        :host .grid .container.expanded .content cotton-checkbox {
            margin-left: -14px;
        }
        :host cotton-checkbox ::content .container {
            margin-top: 4px;
        }
    </style>

    <script>
        const AlexandriaCatalogListDictionary = {
            es: {
                Sortings : "mostrar primero",
                Search : "búsqueda",
                NoItems : "no hay elementos",
                CreateCluster : "crear grupo",
                Deselect : "quitar",
                OneSelectedItem : "1 elemento seleccionado",
                CountSelectedItems : "::count:: elementos seleccionados",
                LotsOfSelectedItems : "más de ::count:: elementos seleccionados",
                RemoveSelection : "quitar"
            },
            en: {
                Sortings : "show first",
                Search : "search",
                NoItems : "no elements",
                CreateCluster : "create group",
                Deselect : "deselect",
                OneSelectedItem : "::count:: selected items",
                CountSelectedItems : "::count:: selected items",
                LotsOfSelectedItems : "more than ::count:: selected items",
                RemoveSelection : "remove"
            }
        };

        Polymer({
            is: 'alexandria-catalog-list',

            properties: {
                grid: { type: Boolean, observer: '_refreshClasses' },
                width: { type: Number, observer: '_refreshWidth' },
                emptyMessage : { type: String, notify: true, observer: '_refreshEmptyMessage' },
                _emptyMessage : String,
                _offsetWidth: Number,
                embedded: Boolean,
                canSearch: { type: Boolean, observer: '_refreshToolbar' },
                canCreateClusters: Boolean,
                clusterList: { type: Array, value: function() { return []; } },
                sortingList: { type: Array, value: function() { return []; }, observer: '_refreshToolbar' },
                mold : Object,
                selectedSorting: Object,
                pageSize: Number,
                itemList: { type: Array, observer: '_refresh' },
                countItemList : { type: Number, value: function() { return -1; } },
                toolbar : { type: Object, observer: '_refreshToolbar' },
                condition : { type: String, value: function() { return ""; } },
                _countSelectionOperations : { type: Number, value: function() { return 0; } },
                _allowSelection : Boolean,
                _itemList: { type: Array, value: function() { return []; } },
                _classes : { type: String, value: function () { return ""; } },
                _clusterPanelVisible: { type: Boolean, value: function() { return false; } },
                _toolbarHidden: { type: Boolean, value: function() { return false; } },
                _groupMap : { type: Object, value: function() { return {}; } },
                _page : Number,
                _selectionEnabled : { type: Boolean, value: function() { return false; } }
            },

            behaviors: [ CottonBehaviors.TranslatorBehavior, AlexandriaBehaviors.CatalogBehavior, AlexandriaBehaviors.DateBehavior ],

            attached: function () {
                this.translate(AlexandriaCatalogListDictionary);
                this._groupMap = {};
                this._resized = false;
                window.setTimeout(() => this._refreshListSelectionEnabled(false), 100);
            },

            _refreshListSelectionEnabled : function(value) {
                this.$.items.selectionEnabled = this._countSelectionOperations > 0 && value;
            },

            _refreshWidth : function() {
                this._offsetWidth = this._countSelectionOperations > 0 ? 40 : 20;
            },

            _refreshEmptyMessage : function() {
                this._emptyMessage = this.emptyMessage != null && this.emptyMessage != "" ? this.emptyMessage : this.NoItems;
            },

            _resize : function() {
                if (this.resizeTimeout != null)
                    window.clearTimeout(this.resizeTimeout);

                var list = $(this.querySelector("cotton-list"));
                var parent = list.parent().get(0);
                list.height($(parent).height()-this._listOffsetHeight());

                this.resizeTimeout = window.setTimeout(() => {
                    var list = this.querySelector("iron-list[grid]");
                if (list == null) return;
                var height = -1;
                list.querySelectorAll(".item.container").forEach(function(container) {
                    if (height == -1) height = $(container).height();
                    $(container).height(height);
                });
            }, 100);
            },

            _listOffsetHeight : function() {
                return this.querySelector("iron-list[grid]") != null ? 2 : 12;
            },

            clear : function() {
                this._page = 0;
                this.notifyPath('_itemList', []);
                this.$.items.fire("iron-resize");
                var list = this.querySelector("cotton-list");
                if (list != null) list.clear();
            },

            refreshItem : function(item) {
                var oldItem = this._getComponentItem(this.$.items, item.name);
                var index = this._getComponentItemIndex(this.$.items, item.name);

                item.group = oldItem.group;

                this.set("itemList." + index, item);
                this.set("_itemList." + index, item);
                for (var i=0;i<this.selectedItemList.length;i++)
                    if (this.selectedItemList[i].name === oldItem.name)
                        this.set("selectedItemList." + i, item);

                var item = this.querySelector("alexandria-mold[name=\"_item_" + item.name + "\"]");
                if (item != null) item.highlight();
            },

            refreshItemPicture : function(pictureData) {
                var itemName = pictureData.item;
                let item = this.querySelector("alexandria-mold[name=\"_item_" + itemName + "\"]");
                if (item == null) return;
                item.refreshPicture(pictureData);
                window.setTimeout(() => this._updateSizeForItem(itemName), 100);
            },

            _refreshToolbar: function() {
                this._countSelectionOperations = this._operations(this.toolbar,"Selection").length > 0;
                this._allowSelection = this._countSelectionOperations > 0;
                this._toolbarHidden = this.toolbar != null && this.toolbar.operationList.length <= 0 &&
                    !this.canSearch && this.sortingList.length <= 0;
            },

            _refresh: function() {
                var selected = this.$.items.selectedItem;
                let offset = this._itemList.length;

                this._generateGroups(this.itemList);
                for (var i=0; i<this.itemList.length; i++) {
                    var item = this.itemList[i];
                    item.group = { style: this._groupStyle(i+offset), label: this._groupLabel(item) };
                    this.push("_itemList", item);
                }

                if (selected != null) {
                    var widget = this;
                    window.setTimeout(function() {
                        var item = widget._getComponentItem(widget.$.items, selected.name);
                        if (item != null)
                            widget.$.items.selectItem(item);
                    }, 200);
                }

                var listElement = this.querySelector("cotton-list");
                if (listElement != null) listElement.pageLoaded();

                if (!this._resized) {
                    window.setTimeout(() => {
                        this.$.items.fire("iron-resize");
                    this._resized = true;
                }, 50);
                }
            },

            _generateGroups : function(itemList) {
                let page = this._page;
                if (page == 0) this._groupMap = {};

                let offset = this._itemList.length;
                for (var i=0; i<itemList.length; i++) {
                    var index = i + offset;
                    var item = itemList[i];
                    if (item.group == null) continue;

                    if (index == 0 || (i > 0 && item.group != itemList[i-1].group) ||
                        (this._groupMap[index-1] != null && this._groupMap[index-1] != item.group)) {
                        this._groupMap[index] = item.group;
                    }
                }
            },

            _refreshClasses : function() {
                this._classes = this.grid ? "grid" : "list";
            },

            _loadPage : function(event) {
                this._page = event.detail.page;
                this.fire("load-page", { page: event.detail.page });
            },

            refreshSelection : function(selection) {
                this._refreshSelection(this.$.items, selection);
            },

            _selectionChanged: function() {
                if (this.selectedItemList == null) return;
                this._clusterPanelVisible = this.canCreateClusters && this.selectedItemList.length > 0 && this._countSelectionOperations > 0;
                this.$.items.fire("iron-resize");
                let items = this.selectionOf(this.$.items).items;
                this.fire("select-items", items);
                this._updateSizeForItems(items);
                this._updateCheckboxes(items);
            },

            _clearSelection : function() {
                this.clearSelection(this.$.items);
                this.fire("select-items", []);
            },

            _updateSizeForItems : function(items) {
                window.setTimeout(() => {
                    for (var i=0; i<items.length; i++) {
                    this._updateSizeForItem(items[i]);
                }
            }, 100);
            },

            _updateSizeForItem : function(item) {
                var list = this.querySelector('iron-list');
                list.updateSizeForItem(this._getComponentItem(list, item));
            },

            _classForItem: function(item, selected) {
                var clazz = "container item";
                clazz += selected ? ' expanded' : ' collapsed';
                return clazz;
            },

            _unSelectItem: function(e) {
                this.unSelectItem(this.$.items, e.model.item.name);
                this._updateCheckboxes();
            },

            _countSelectedItemList : function(count) {
                if (this.CountSelectedItems == null) return "";

                var message = "";
                if (count == 1) message = this.OneSelectedItem;
                else if (count <= 50) message = this.CountSelectedItems;
                else message = this.LotsOfSelectedItems;

                return message.replace("::count::", count).replace("::total::", this.countItemList);
            },

            _openStampDialog : function(event) {
                this.fire("open-stamp-dialog", event.detail);
            },

            _executeStampTask : function(event) {
                this.fire("execute-stamp-task", event.detail);
            },

            _clearFilter : function() {
                this.$.filter.value = "";
                this.condition = "";
                this.fire("filter", this.condition);
            },

            _filter : function() {
                window.setTimeout(() => {
                    var condition = this.$.filter.value;
                if (this.condition === condition) return;
                this.condition = condition;
                this.fire("filter", condition);
            }, 800);
            },

            _groupStyle : function(idx) {
                var display = this._groupMap[idx] != null ? "block" : "none";
                return "display:" + display + ";";
            },

            _groupLabel : function(item) {
                if (item.group == null) return "";
                var language = this.getLanguage();
                return this.fullDayOf(new Date(item.group), language);
            },

            _showClusterDialog : function() {
                this.querySelector("alexandria-catalog-cluster-dialog").open();
            },

            _executeOperation : function(e) {
                this.fire("execute-operation", e.detail);
            },

            _alwaysOperations : function(toolbar) {
                return this._operations(toolbar,"Always");
            },

            _selectionOperations : function(toolbar) {
                return this._operations(toolbar,"Selection");
            },

            _operations : function(toolbar, when) {
                var result = [];
                if (toolbar == null) return result;
                var operationList = toolbar.operationList;
                for (var i=0; i<operationList.length; i++) {
                    if (operationList[i].when != when) continue;
                    result.push(operationList[i]);
                }
                return result;
            },

            _downloadOperation : function(e) {
                this.fire("download-operation", e.detail);
            },

            _toggleSelection : function(e) {
                if (this.selectedItemList == null || this.selectedItemList.length <= 0) {
                    this._selectionEnabled = e.detail;
                    this._refreshListSelectionEnabled(this._selectionEnabled);
                }
                let name = e.target.getAttribute("name");
                if (e.detail) this.selectItem(this.$.items, name);
                else this.unSelectItem(this.$.items, name);
                this._getComponentItem(this.$.items, name).checked = e.detail;
            },

            _updateCheckboxes : function() {
                this.querySelectorAll("cotton-checkbox").forEach(c => c.checked = false);
                if (this.selectedItemList.length <= 0 && this._selectionEnabled) {
                    this._selectionEnabled = false;
                    this._refreshListSelectionEnabled(this._selectionEnabled)
                }
                if (!this._selectionEnabled) return;
                for(var i=0; i<this.selectedItemList.length; i++) {
                    var checkbox = this.querySelector("cotton-checkbox[name='" + this.selectedItemList[i].name + "']");
                    if (checkbox != null) checkbox.checked = true;
                }
            },

            _openItem : function(e) {
                if (this._selectionEnabled) return;
                var target = e.target;
                var name = target.getAttribute("name");
                if (!$(target).hasClass(".container.item")) name = $(target).parents(".container.item")[0].getAttribute("name");
                this.fire("open-item", name);
            }

        });
    </script>

</dom-module>
