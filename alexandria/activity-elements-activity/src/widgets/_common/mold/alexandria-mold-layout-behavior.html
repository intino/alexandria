<script>
    'use strict';

    var AlexandriaBehaviors = AlexandriaBehaviors || {};

    AlexandriaBehaviors.MoldLayoutBehavior = {
        _onRefresh : null,

        properties : {
            item: { type: Object, notify: true, value: function () { return null; }, observer: '_initMold' },
            mode: { type: String, notify: true, value: function () { return "list"; }, observer: '_initMold' },
            hasExpandedBlocks: { type: Boolean, value: function () { return false; } }
        },

        blocks : function() { return []; },
        stamps : function() { return []; },

        highlight: function() {
            var highlight = $(this.querySelector("#highlight"));
            highlight.addClass("visible");
            window.setTimeout(() => highlight.removeClass("visible"), 1500);
        },

        refreshPicture : function(pictureData) {
            var element = this.querySelector(".picture_img_" + pictureData.stamp);
            element.src = pictureData.value;
        },

        _initMold : function() {
            if (this.item == null || this.item.length === 0 || this.mode == null) return;
            this._initBlocks(this.blocks());
            this._initStamps(this.stamps());
            this.hasExpandedBlocks = this._hasExpandedBlocks();
            if (this._onRefresh) this._onRefresh();
        },

        _refreshItem : function() {
        },

        _hasExpandedBlocks : function() {
            var blocks = this.blocks();
            for (let i=0; i<blocks.length; i++)
                if (blocks[i].expanded) return true;
            return false;
        },

        _initBlocks : function(blocks) {
            for (let i=0; i<blocks.length; i++) {
                var block = blocks[i];
                this[block.name] = this._initBlock(block);
            }
        },

        _initBlock : function(block) {
            var result = block;
            result.style = block.style != null ? block.style : "";
            result.expanded = block.expanded != null ? block.expanded : false;
            result.hiddenIfMobile = block.hiddenIfMobile != null ? block.hiddenIfMobile : false;
            result.hidden = this._blockHidden(block);
            result.layout = this._blockLayout(block);
            result.width = this._blockWidth(block);
            result.height = this._blockHeight(block);
            result.mode = this.mode;
            return block;
        },

        _allowLazyLoad : function() {
            return this.mode == "list" || this.mode == "grid";
        },

        _blockHidden : function(block) {
            var result = this.item.itemBlockList.filter(s => s.name == block.name);
            return result.length > 0 ? result[0].hidden : false;
        },

        _blockLayout : function (block) {
            var layout = block.layout.toLowerCase();
            layout = layout.replace("startjustified", "start-justified");
            layout = layout.replace("centerjustified", "center-justified");
            layout = layout.replace("endjustified", "end-justified");
            layout = layout.replace("fixed", "");
            layout = layout.replace("flexible", "flex");
            return layout !== "" ? "layout " + layout : "";
        },

        _blockWidth : function (block) {
            return block.width != null && block.width != -1 ? block.width + "%" : "100%";
        },

        _blockHeight : function (block) {
            return block.height != null && block.height != -1 ? block.height + "%" : "-1";
        },

        _initStamps : function(stamps) {
            for (let i=0; i<stamps.length; i++) {
                var stamp = stamps[i];
                this[stamp.name] = this._initStamp(stamp);
            }
        },

        _initStamp : function(stamp) {
            stamp.properties = stamp.properties != null ? stamp.properties : {};
            this._initStampProperties(stamp);
            stamp.mode = this.mode;
            stamp.label = stamp.label != null ? this._parseFunctions(stamp.label) : "";
            stamp.item = this.item.name;
            stamp.singleValue = this._singleValue(stamp);
            stamp.countValues = this._countValuesOf(stamp);
            stamp.value = this._parseFunctions(this._valueOf(stamp));
            stamp.values = this._valuesOf(stamp);
            stamp.classes = this._classesFor(stamp);
            stamp.height = stamp.height !== -1 ? stamp.height + "%" : "100%";
            return stamp;
        },

        _initStampProperties : function(stamp) {
            this._initIconProperties(stamp);
            this._initBreadcrumbsProperties(stamp);
            this._initDownloadOperationProperties(stamp);
            this._initPreviewOperationProperties(stamp);
            this._initExportOperationProperties(stamp);
            this._initTaskOperationProperties(stamp);
            this._initItemLinksProperties(stamp);
            this._initLocationProperties(stamp);
            this._initCardWalletProperties(stamp);
            this._initHighlightProperties(stamp);
            this._initCatalogLinkProperties(stamp);
        },

        _initIconProperties : function(stamp) {
            if (stamp.type !== "icon") return;
            let iconType = stamp.properties.iconType;
            var icon = this._valueOf(stamp);
            if (icon == null || icon === "") {
                icon = "warning";
                stamp.value = "";
            }
            stamp.properties.icon = iconType === "alexandria" ? icon : "";
        },

        _initBreadcrumbsProperties : function(stamp) {
            if (stamp.type !== "breadcrumbs") return;
            var value = this._valueOf(stamp);
            var tree = (value !== "") ? JSON.parse(value) : { items: [] };
            stamp.properties.breadcrumbs = this.treeToBreadcrumbs(tree);
        },

        _initDownloadOperationProperties : function(stamp) {
            if (stamp.type !== "download-operation") return;
            var options = stamp.properties.options;
            stamp.properties.options = options !== null && options !== "" ? options.split(",") : [];
        },

        _initPreviewOperationProperties : function(stamp) {
            if (stamp.type !== "preview-operation") return;
            stamp.properties.document = this._propertyValueOf(stamp, 'document');
        },

        _initExportOperationProperties : function(stamp) {
            if (stamp.type !== "export-operation") return;
            var options = stamp.properties.options;
            stamp.properties.options = options !== null && options !== "" ? options.split(",") : [];
        },

        _initTaskOperationProperties : function(stamp) {
            if (stamp.type !== "task-operation") return;
            stamp.properties.confirm = this._parseFunctions(stamp.properties.confirm);
        },

        _initItemLinksProperties : function(stamp) {
            if (stamp.type !== "item-links") return;
            var value = this._valueOf(stamp);
            stamp.properties.links = (value != "") ? JSON.parse(value).items : [];
        },

        _initLocationProperties : function(stamp) {
            if (stamp.type !== "location") return;
            stamp.properties.icon = this._propertyValueOf(stamp,'icon');
            stamp.properties.drawingColor = this._propertyValueOf(stamp,'drawingColor');
        },

        _initCardWalletProperties : function(stamp) {
            if (stamp.type !== "card-wallet") return;
            var value = this._parseFunctions(this._valueOf(stamp));
            stamp.properties.wallet = (value != "") ? JSON.parse(value) : { cards: [] };
        },

        _initHighlightProperties : function(stamp) {
            if (stamp.type !== "highlight") return;
            stamp.properties.color = this._propertyValueOf(stamp, 'color');
        },

        _initCatalogLinkProperties : function(stamp) {
            if (stamp.type !== "catalog-link") return;
            stamp.label = this._parseFunctions(this._valueOf(stamp));
        },

        _singleValue: function (stamp) {
            if (this.item == null) return true;
            return this.mode == "map" || this._itemFromStamp(stamp).values.length == 1;
        },

        _valueOf: function (stamp) {
            if (this.item == null) return "";
            let values = this._itemFromStamp(stamp).values;
            let value = values.length > 0 ? values[0] : "";

            if (stamp.type === "picture") {
                if (this._allowLazyLoad() && stamp.expanded)
                    value = "data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
                else
                    value += value != null && value != "" ? ((value.indexOf("?") != -1 ? "&" : "?") + "random=" + Math.random()) : "";
            }

            return value;
        },

        _valuesOf: function (stamp) {
            if (this.item == null) return [];
            return this._itemFromStamp(stamp).values;
        },

        _countValuesOf: function (stamp) {
            return this._valuesOf(stamp).length;
        },

        _propertyValueOf: function (stamp, propertyName) {
            var property = this._propertyOf(stamp.properties, propertyName);
            if (property == null && this.item != null) property = this._propertyOf(this._itemFromStamp(stamp).propertyList, propertyName);
            return property !== null ? property.value : "";
        },

        _classesFor : function(stamp) {
            return stamp.layout != null && stamp.layout.toLowerCase() === "flexible" ? "flex" : "";
        },

        _itemFromStamp: function(stamp) {
            var result = this._itemFromStampName(stamp.name);
            return result != null ? result : { values: [], propertyList: [] };
        },

        _itemFromStampName: function(stamp) {
            var result = this.item.itemStampList.filter(s => s.name == stamp);
            return result.length > 0 ? result[0] : null;
        },

        _propertyOf: function (propertyList, property) {
            for (var i = 0; i < propertyList.length; i++)
                if (propertyList[i].name === property)
                    return propertyList[i];
            return null;
        },

        _parseFunctions : function(value) {
            value = this._parseDates(value);
            value = this._parsePercentages(value);
            value = this._parseNumbers(value);
            value = this._parseItemLinks(value);
            return value;
        },

        _parseDates : function(value) {
            var regExp = new RegExp(/date\(([^,]*),([^\)]*)\)/);
            var match = regExp.exec(value);
            if (match == null) return value;

            var language = this.getLanguage();
            moment.locale(language);
            while (match != null) {
                var date = moment(new Date(parseInt(match[1]))).format(match[2]);
                value = value.replace(match[0], date);
                match = regExp.exec(value);
            }

            return value;
        },

        _parsePercentages : function(value) {
            var regExp = new RegExp(/percentage\('([^']*)',([^\)]*)\)/);
            var match = regExp.exec(value);
            if (match == null) return value;

            while (match != null) {
                var formatted = numeral(parseFloat(match[1])).format(match[2]);
                value = value.replace(match[0], formatted);
                match = regExp.exec(value);
            }

            return value;
        },

        _parseNumbers : function(value) {
            var regExp = new RegExp(/number\('([^']*)','([^']*)'\)/);
            var match = regExp.exec(value);
            if (match == null) return value;

            while (match != null) {
                var formatted = numeral(parseFloat(match[1])).format(match[2]);
                value = value.replace(match[0], formatted);
                match = regExp.exec(value);
            }

            return value;
        },

        _parseItemLinks : function(value) {
            var regExp = new RegExp(/itemLink\('([^']*)','([^']*)'\)/);
            var match = regExp.exec(value);
            if (match == null) return value;

            while (match != null) {
                var link = "<a class='mold-item-link' name='" + match[1] + "'>" + match[2] + "</a>";
                value = value.replace(match[0], link);
                match = regExp.exec(value);
            }

            return value;
        }
    };

</script>
