<link rel="import" href="../../../../lib/polymer/polymer.html">
<link rel="import" href="../../../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../../../../lib/google-map/google-map.html">
<link rel="import" href="alexandria-mold-map-item.html">

<dom-module id="alexandria-mold-map">

    <template>
        <google-map map="{{map}}"
                    additional-map-options="[[_options]]"
                    latitude="[[latitude]]"
                    longitude="[[longitude]]"
                    min-zoom="[[zoom]]"
                    zoom="[[zoom]]"
                    max-zoom="[[zoom]]"
                    api-key="[[_googleApiKey]]"
                    fit-to-markers="true"
                    disable-map-type-control="true"
                    disable-default-ui
                    disable-street-view-control="true"></google-map>

        <alexandria-mold-map-item value="[[marker]]" drawing-color="black"></alexandria-mold-map-item>
    </template>

    <style>
        :host google-map {
            width: 100%;
            height: 100%;
        }
    </style>

    <script>
        const AlexandriaMoldMapDictionary = {
            es: {
            },
            en: {
            }
        };

        Polymer({
            is: 'alexandria-mold-map',

            behaviors: [ CottonBehaviors.TranslatorBehavior ],

            properties : {
                map: Object,
                marker : { type: String, observer: '_update', value: function() { return null; } },
                zoom : Number,
                latitude : Number,
                longitude : Number,
                _googleApiKey: { type: String, value: function() { return window.Application.configuration.googleApiKey; } }
            },

            attached: function () {
                this.translate(AlexandriaMoldMapDictionary);
                this._prepareMap();
            },

            _prepareMap : function() {
                var element = this.querySelector("google-map");
                element.addEventListener('google-map-ready', (e) => this._update());
            },

            _update : function() {
                this._updateMap();
            },

            _updateMap : function() {
                if (this._refreshTimeout != null)
                    window.clearTimeout(this._refreshTimeout);

                var mapContainer = this.querySelector("google-map");
                var map = mapContainer.map;
                if (map != null) map.closeInfoWindows = () => this.closeInfoWindows();

                this._refreshTimeout = window.setTimeout(() => this.querySelectorAll("alexandria-mold-map-item").forEach((item) => item.setMap(map)), 100);
            }

        });
    </script>

</dom-module>
