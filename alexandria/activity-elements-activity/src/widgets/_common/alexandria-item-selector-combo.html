<link rel="import" href="../../../lib/polymer/polymer.html">
<link rel="import" href="../../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../../../lib/paper-item/paper-item.html">
<link rel="import" href="../../../lib/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../lib/paper-menu-button/paper-menu-button.html">

<dom-module id="alexandria-item-selector-combo">

    <template>
        <paper-menu-button vertical-align="[[verticalAlign]]" class$="hidden_[[_hidden]]">
            <paper-button class="dropdown-trigger" title="[[label]]" on-tap="_opened"><span class="button-text">[[textValue]]</span><iron-icon icon="icons:arrow-drop-down"></iron-icon></paper-button>
            <paper-menu id="menu" class="dropdown-content" on-iron-select="_onItemSelected" selected$="[[_selected]]" vertical-align="bottom">
                <template is="dom-repeat" items="[[items]]">
                    <paper-item name$="[[item.name]]">{{item.label}}</paper-item>
                </template>
            </paper-menu>
        </paper-menu-button>
    </template>

    <style>
        :host paper-menu-button.hidden_true {
            display: none;
        }
        :host {
            display: inline-block;
            position: relative;
            --paper-menu-background-color: #fff;
            --paper-menu-button-dropdown-background: #fff;
            --paper-menu-button-content : {
                border: 1px solid var(--default-primary-color);
                margin: 6px;
                padding: 1px;
                left: -6px !important;
                max-height: 136px !important;
                min-width: 250px;
                width: 250px;
            };
        }

        paper-menu-button {
            padding: 0;
            width: 100%;
        }

        paper-menu {
            width: 238px;
        }

        paper-button {
            padding: 0;
            color: black;
            font-size: var(--text-size, 11pt);
        }

        :host[boxed] .dropdown-trigger {
            background: white;
            min-width: 150px;
            border: 1px solid #ddd;
            padding: 0 0 0 8px;
            @apply(--layout-horizontal);
        }

        :host[boxed] .dropdown-trigger span {
            @apply(--layout-flex);
        }

        paper-button.no-selection {
            color: #777;
        }

        paper-menu-button paper-button {
            background-color: transparent;
        }

        paper-button iron-icon {
            color: var(--default-primary-color);
        }

        paper-menu-button[disabled] paper-button iron-icon {
            color: var(--disabled-text-color);
        }

        paper-menu {
            padding: 0;
        }

        paper-item {
            @apply(--option-style);
            cursor: pointer;
            line-height: 16px;
            min-height: 26px;
            font-size: 10pt;
            padding: 3px 10px;
        }

        paper-item:hover {
            background-color: var(--accent-color);
        }

        @media screen and (max-width: 736px) {
        }
    </style>

    <script>
        const AlexandriaItemSelectorComboDictionary = {
            es: {
            },
            en: {
            }
        };

        Polymer({
            is: 'alexandria-item-selector-combo',
            _refreshing : false,

            behaviors: [ CottonBehaviors.TranslatorBehavior, Polymer.IronResizableBehavior ],

            properties: {
                label: String,
                items: { type: Array, observer: '_refresh' },
                selected: { type: Object, observer: '_refreshSelected' },
                verticalAlign: { type: String, value: function() { return 'bottom'; } },
                _hidden: { type: Boolean },
                _selected: { type: String, value: function() { return 0; } }
            },

            listeners: {
                'iron-resize': '_resize'
            },

            attached: function () {
                this.translate(AlexandriaItemSelectorComboDictionary);
                this.textValue = this.label;
                this._refresh();
            },

            _onItemSelected: function (event) {
                var selected = event.detail.item.getAttribute("name");
                var index = this._itemIndexOf(selected);
                this.textValue = event.detail.item.textContent.trim();
                this._refresh();

                if (index == this._selected)
                    return;

                this._selected = index;
                if (!this._refreshing)
                    this.fire('item-selected', selected);
            },

            _refresh : function() {
                let isLabel = this.textValue == this.label;
                let buttonElement = $(this.querySelector("paper-button"));

                this._hidden = this.items != null && this.items.length <= 1;

                buttonElement.removeClass("no-selection");
                if (isLabel)
                    buttonElement.addClass("no-selection");
            },

            _refreshSelected : function() {
                var index = this._itemIndexOf(this.selected.name);
                this._refreshing = true;
                this._selected = index;
                this._refreshing = false;
            },

            _itemIndexOf : function(key) {
                for (var i=0; i<this.items.length; i++)
                    if (this.items[i].name == key || this.items[i].label == key)
                        return i;
                return 0;
            },

            _opened : function() {
                this._resize();
            },

            _resize : function() {
                var widget = this;
                window.setTimeout(function () {
                    var menu = widget.querySelector("iron-dropdown");
                    var button = $(widget.querySelector("paper-button"));
                    var offset = button.offset();
                    var offsetTop = 0;
                    var offsetLeft = offset.left;
                    var menuWidth = $(menu).width();
                    var windowWidth = $(window).width();

                    if (widget.verticalAlign == "bottom")
                        offsetTop = offset.top + button.height();
                    else
                        offsetTop = offset.top - $(menu).height();

                    if (offset.left+menuWidth > windowWidth)
                        offsetLeft = offset.left - menuWidth + 70;

                    $(menu).offset({ top: offsetTop, left: offsetLeft });
                }, 10);
            }

        });
    </script>
</dom-module>
