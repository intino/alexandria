<link rel="import" href="../../../lib/polymer/polymer.html">
<link rel="import" href="../../../lib/cotton-push/cotton-push-behavior.html">
<link rel="import" href="../../../lib/cotton-carrier/cotton-carrier-behavior.html">
<link rel="import" href="../../../lib/cotton-zombie/cotton-zombie.html">
<link rel="import" href="../../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../../../lib/cotton-layout/cotton-layout.html">
<link rel="import" href="../../../lib/paper-menu/paper-menu.html">
<link rel="import" href="../../../lib/paper-menu/paper-submenu.html">
<link rel="import" href="../../../lib/cotton-header/cotton-header.html">
<link rel="import" href="../_common/alexandria-item-selector-combo.html">
<link rel="import" href="../_common/layout/alexandria-layout-behavior.html">

<script src="requester.js"></script>
<script src="notifier-listener.js"></script>
<script src="../../../lib/cotton-delay-executor/DelayExecutor.js"></script>

<dom-module id="alexandria-menu-layout-drawer">

    <template>
        <cotton-header id="layout" title="[[_title]]" subtitle="[[_subtitle]]" logo="[[_logo]]" on-logout="_logout" on-edit-profile="_editProfile">
            <content select="#header-content"></content>
        </cotton-header>
        <paper-menu selected="{{_selectedItem}}" attr-for-selected="name">
            <template is="dom-repeat" items="[[_groupList]]" as="group">
                <template is="dom-if" if="{{_singleGroup(group)}}">
                    <template is="dom-repeat" items="{{group.list}}" as="item">
                        <paper-item name$="[[item.label]]">[[item.label]]</paper-item>
                    </template>
                </template>
                <template is="dom-if" if="{{!_singleGroup(group)}}">
                    <paper-submenu opened$="[[group.opened]]">
                        <paper-item class="menu-trigger">[[group.label]]</paper-item>
                        <paper-menu class="menu-content" selected="{{_selectedItem}}" attr-for-selected="name">
                            <template is="dom-repeat" items="{{group.list}}" as="item">
                                <paper-item name$="[[item.label]]">[[item.label]]</paper-item>
                            </template>
                        </paper-menu>
                    </paper-submenu>
                </template>
            </template>
        </paper-menu>
    </template>

    <style>
        :host {
            display: block;
            height: 100%;
        }
        :host paper-menu {
            width: 250px;
            background: white;
            --paper-menu-selected-item : {
                background: #e0e0e0;
                font-weight: normal;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
            }
        }
        :host paper-submenu paper-menu {
            margin-left: 20px;
            width: calc(100% - 20px);
        }
        :host paper-item {
            font-size: 11pt;
            min-height: 30px;
            margin: 0 10px;
            cursor: pointer;
        }
        @media screen and (max-width: 736px) {
        }
    </style>

    <script>
        const AlexandriaMenuLayoutDrawerDictionary = {
            es: {
            },
            en: {
            }
        };

        Polymer({
            is: 'alexandria-menu-layout-drawer',
            _resizing: false,
            _itemsPositions : [],

            behaviors: [ CottonBehaviors.CarrierBehavior,
                CottonBehaviors.PushBehavior,
                CottonBehaviors.TranslatorBehavior,
                AlexandriaMenuLayoutBehaviors.Requester,
                AlexandriaMenuLayoutBehaviors.NotifierListener,
                AlexandriaBehaviors.LayoutBehavior ],

            properties : {
                _layoutTabList : Array,
                _groupList : Array,
            },

            attached : function() {
                this.translate(AlexandriaMenuLayoutDrawerDictionary);
                this.translate(AlexandriaBehaviors.LayoutBehavior.Dictionary);
                this.listenToDisplay();
                this._layoutTabList = ["home"];
            },

            _selectItemByLabel : function(label) {
                if (this._itemList == null || this._itemList.length <= 0) return;
                if (label == null) return;
                if (label == 0) label = this._itemList[0].label;
                window.setTimeout(() => this.selectItem(label), 100);
            },

            _refreshSelected : function(selected) {
                this._selectedItem = selected;
            },

            _itemsLoaded : function() {
                this._groupList = this._loadGroups();
            },

            _loadGroups : function() {
                if (this._itemList == null) return;

                var groups = [];
                var registeredGroups = [];
                for (var i=0; i<this._itemList.length; i++) {
                    var groupProperty = this._itemProperty(this._itemList[i], "group");
                    var itemGroup = groupProperty != null ? groupProperty.value : null;
                    if (itemGroup == null) groups.push({ list: [ this._itemList[i] ] });
                    else {
                        if (registeredGroups[itemGroup] == null) {
                            registeredGroups[itemGroup] = { list: [], label: itemGroup, opened: this._itemProperty(this._itemList[i], "group_opened").value };
                            groups.push(registeredGroups[itemGroup]);
                        }
                        registeredGroups[itemGroup].list.push(this._itemList[i]);
                    }
                }

                return groups;
            },

            _singleGroup : function(group) {
                return group.list.length == 1;
            }

        });
    </script>
</dom-module>
