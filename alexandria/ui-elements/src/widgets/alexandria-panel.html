<link rel="import" href="../../lib/polymer/polymer.html">
<link rel="import" href="../../lib/cotton-push/cotton-push-behavior.html">
<link rel="import" href="../../lib/cotton-carrier/cotton-carrier-behavior.html">
<link rel="import" href="../../lib/cotton-zombie/cotton-zombie.html">
<link rel="import" href="../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../../lib/paper-tabs/paper-tabs.html">
<link rel="import" href="../../lib/paper-tabs/paper-tabs-icons.html">
<link rel="import" href="../../lib/cotton-breadcrumbs/cotton-breadcrumbs.html">
<link rel="import" href="../../lib/paper-toast/paper-toast.html">
<link rel="import" href="alexandria-view-container-mold.html">
<link rel="import" href="alexandria-view-container-catalog.html">
<link rel="import" href="alexandria-view-container-panel.html">
<link rel="import" href="alexandria-view-container-display.html">
<link rel="import" href="alexandria-view-container-set.html">
<link rel="import" href="alexandria-dialog-box.html">
<link rel="import" href="_common/alexandria-breadcrumbs-behavior.html">
<link rel="import" href="_common/alexandria-element-behavior.html">
<link rel="import" href="_common/alexandria-view-behavior.html">

<script src="alexandriapanel/requester.js"></script>
<script src="alexandriapanel/notifier-listener.js"></script>

<dom-module id="alexandria-panel">

    <template>
        <cotton-breadcrumbs class="breadcrumbs" items="[[_breadcrumbs]]" on-item-selected="_navigate" hidden$="[[!_breadcrumbs.length]]"></cotton-breadcrumbs>
        <div id="main" class="layout vertical flex" style="height:100%;">
            <div class="summary" hidden$="[[!_hasSummaryViews]]">
                <template is="dom-repeat" items="[[_viewList]]" as="view">
                    <template is="dom-if" if="[[_isSummaryLayoutView(view)]]">
                        <template is="dom-if" if="[[_isMoldContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerMold" widget="AlexandriaViewContainerMold" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                        <template is="dom-if" if="[[_isDisplayContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerDisplay" widget="AlexandriaViewContainerDisplay" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                    </template>
                </template>
            </div>
            <div class$="tabs tabs_[[_showTabs]]">
                <paper-tabs selected="{{_selectedView}}" scrollable no-bar hidden="[[!_showTabs]]" attr-for-selected="name">
                    <template is="dom-repeat" items="[[_viewList]]" as="view">
                        <template is="dom-if" if="[[_isTabLayoutView(view)]]">
                            <paper-tab name$="[[view.name]]" view="[[view]]" hidden$="[[_isViewHidden(view)]]">[[view.label]]</paper-tab>
                        </template>
                    </template>
                </paper-tabs>
            </div>
            <div class="fixed left" hidden$="[[!_hasLeftFixedViews]]">
                <template is="dom-repeat" items="[[_viewList]]" as="view">
                    <template is="dom-if" if="[[_isLeftFixedLayoutView(view)]]">
                        <template is="dom-if" if="[[_isMoldContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerMold" widget="AlexandriaViewContainerMold" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                        <template is="dom-if" if="[[_isCatalogContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerCatalog" widget="AlexandriaViewContainerCatalog" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                        <template is="dom-if" if="[[_isPanelContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerPanel" widget="AlexandriaViewContainerPanel" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                        <template is="dom-if" if="[[_isDisplayContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerDisplay" widget="AlexandriaViewContainerDisplay" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                        <template is="dom-if" if="[[_isSetContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerSet" widget="AlexandriaViewContainerSet" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                    </template>
                </template>
            </div>
            <iron-pages id="tabs-content" class$="flex left_fixed_[[_hasLeftFixedViews]] right_fixed_[[_hasRightFixedViews]]" selected="{{_selectedView}}" attr-for-selected="name">
                <template is="dom-repeat" items="[[_viewList]]" as="view">
                    <template is="dom-if" if="[[_isTabLayoutView(view)]]">
                        <template is="dom-if" if="[[_isMoldContainer(view)]]">
                            <div name$="[[view.name]]" style$="[[_viewStyle(view)]]"><cotton-zombie display="AlexandriaViewContainerMold" widget="AlexandriaViewContainerMold" object$="[[display.id]][[view.name]]"></cotton-zombie></div>
                        </template>
                        <template is="dom-if" if="[[_isCatalogContainer(view)]]">
                            <div name$="[[view.name]]" style$="[[_viewStyle(view)]]"><cotton-zombie display="AlexandriaViewContainerCatalog" widget="AlexandriaViewContainerCatalog" object$="[[display.id]][[view.name]]"></cotton-zombie></div>
                        </template>
                        <template is="dom-if" if="[[_isPanelContainer(view)]]">
                            <div name$="[[view.name]]" style$="[[_viewStyle(view)]]"><cotton-zombie display="AlexandriaViewContainerPanel" widget="AlexandriaViewContainerPanel" object$="[[display.id]][[view.name]]"></cotton-zombie></div>
                        </template>
                        <template is="dom-if" if="[[_isDisplayContainer(view)]]">
                            <div name$="[[view.name]]" style$="[[_viewStyle(view)]]"><cotton-zombie display="AlexandriaViewContainerDisplay" widget="AlexandriaViewContainerDisplay" object$="[[display.id]][[view.name]]"></cotton-zombie></div>
                        </template>
                        <template is="dom-if" if="[[_isSetContainer(view)]]">
                            <div name$="[[view.name]]" style$="[[_viewStyle(view)]]"><cotton-zombie display="AlexandriaViewContainerSet" widget="AlexandriaViewContainerSet" object$="[[display.id]][[view.name]]"></cotton-zombie></div>
                        </template>
                    </template>
                </template>
            </iron-pages>
            <div class="fixed right" hidden$="[[!_hasRightFixedViews]]">
                <template is="dom-repeat" items="[[_viewList]]" as="view">
                    <template is="dom-if" if="[[_isRightFixedLayoutView(view)]]">
                        <template is="dom-if" if="[[_isMoldContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerMold" widget="AlexandriaViewContainerMold" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                        <template is="dom-if" if="[[_isCatalogContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerCatalog" widget="AlexandriaViewContainerCatalog" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                        <template is="dom-if" if="[[_isPanelContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerPanel" widget="AlexandriaViewContainerPanel" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                        <template is="dom-if" if="[[_isDisplayContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerDisplay" widget="AlexandriaViewContainerDisplay" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                        <template is="dom-if" if="[[_isSetContainer(view)]]">
                            <cotton-zombie display="AlexandriaViewContainerSet" widget="AlexandriaViewContainerSet" object$="[[display.id]][[view.name]]"></cotton-zombie>
                        </template>
                    </template>
                </template>
            </div>
        </div>
        <div id="panel" name="panel" class="layout vertical flex hidden" style="height:calc(100% - 60px);"></div>
        <cotton-zombie display="AlexandriaDialogBox" widget="AlexandriaDialogBox"></cotton-zombie>
        <paper-toast id="notifyMessageToast" class="fit-bottom message" text="[[_notifyMessage]]"></paper-toast>
    </template>

    <style>
        :host {
            position: relative;
        }
        :host .breadcrumbs {
            @apply(--alexandria-panel-breadcrumbs);
        }
        :host paper-tabs {
            background: var(--default-primary-color);
            color: white;
            height: 30px;
            @apply(--alexandria-panel-tabs);
        }
        :host paper-tab {
            -webkit-flex: none;
            flex: none;
            width: 100px;
            color: white;
            @apply(--alexandria-panel-tab);
        }
        :host paper-tabs[no-bar] paper-tab.iron-selected {
            background: white;
            color: black;
            @apply(--alexandria-panel-tab-selected);
        }
        :host #tabs-content {
            height: calc(100% - 30px);
            overflow: auto;
        }
        :host #panel {
            display: block;
            margin: 0 6px;
            width: calc(100% - 12px);
            @apply(--alexandria-panel-panels);
        }
        :host #main {
            position: relative;
        }
        :host #main.hidden, :host #panel.hidden {
            position: absolute;
            left: -10000px;
        }
        :host cotton-breadcrumbs {
            display: block;
            padding: 10px;
            --cotton-breadcrumbs-item-color: var(--default-primary-color);
            --cotton-breadcrumbs-item-border-color: var(--footer-background-color);
            --cotton-breadcrumbs-item-size: 12pt;
            --cotton-breadcrumbs-item-brothers-size: 12pt;
            --cotton-breadcrumbs-item-parents-size: 12pt;
        }
        :host .fixed {
            position: fixed;
            margin-top: 35px;
            overflow: auto;
            height: calc(100% - 200px);
            @apply(--alexandria-panel-view-fixed);
        }
        :host .fixed.left {
            width: var(--alexandria-panel-view-fixed-width, 150px);
            @apply(--alexandria-panel-view-fixed-left);
        }
        :host .fixed.right {
            right: 0;
            @apply(--alexandria-panel-view-fixed-right);
        }
        :host iron-pages > div {
            height: 100%;
        }
        :host iron-pages.left_fixed_true {
            margin-left: var(--alexandria-panel-view-fixed-width, 150px);
            padding-left: 10px;
        }
        :host iron-pages.right_fixed_true {
            width: var(--alexandria-panel-view-fixed-width, calc(100% - 150px));
        }
        @media screen and (max-width: 736px) {
            :host cotton-breadcrumbs {
                margin-left: 30px;
                margin-top: -3px;
                margin-bottom: 0;
                padding-bottom: 0;
            }
            :host .tabs.tabs_true {
                width: 100%;
                min-height: 30px;
            }
        }
        @media screen and (max-width: 540px) {
            :host cotton-breadcrumbs {
                margin-top: 5px;
            }
        }
    </style>

    <script>

        const AlexandriaPanelDictionary = {
            es: {
            },
            en: {
            }
        };

        Polymer({
            is: 'alexandria-panel',
            lastView: null,

            behaviors: [ CottonBehaviors.CarrierBehavior,
                CottonBehaviors.PushBehavior,
                CottonBehaviors.TranslatorBehavior,
                AlexandriaBehaviors.BreadcrumbsBehavior,
                AlexandriaBehaviors.ElementBehavior,
                AlexandriaBehaviors.ViewBehavior,
                AlexandriaPanelBehaviors.Requester,
                AlexandriaPanelBehaviors.NotifierListener ],

            properties : {
                _viewList : Array,
                _showTabs : Boolean,
                _selectedView : { type: String, value: function() { return null; }, observer: '_selectView' },
                _selectedPage : { type: Number, value: function () { return 0; } },
                _hasSummaryViews : { type: Boolean, value: function() { return false; }},
                _hasLeftFixedViews : { type: Boolean, value: function() { return false; }},
                _hasRightFixedViews : { type: Boolean, value: function() { return false; }}
            },

            attached : function() {
                this.translate(AlexandriaPanelDictionary);
                this.listenToDisplay();
                this.listenOpenEvents();
            },

            _refreshViewList : function(viewList) {
                this._viewList = viewList;
                this._showTabs = viewList.length > 1;
                this._hasSummaryViews = this._countSummaryViews() > 0;
                this._hasLeftFixedViews = this._countLeftFixedViews() > 0;
                this._hasRightFixedViews = this._countRightFixedViews() > 0;
            },

            _refreshSelectedView : function(name) {
                if (this._selectedView == name) return;
                this._selectedView = name;
            },

            _countSummaryViews : function() {
                var count = 0;
                for (var i=0; i<this._viewList.length; i++)
                    if (this._isSummaryLayoutView(this._viewList[i])) count++;
                return count;
            },

            _countLeftFixedViews : function() {
                var count = 0;
                for (var i=0; i<this._viewList.length; i++)
                    if (this._isLeftFixedLayoutView(this._viewList[i])) count++;
                return count;
            },

            _countRightFixedViews : function() {
                var count = 0;
                for (var i=0; i<this._viewList.length; i++)
                    if (this._isRightFixedLayoutView(this._viewList[i])) count++;
                return count;
            },

            _isSummaryLayoutView : function(view) {
                return view.referencePropertyList[1].value == "summary";
            },

            _isLeftFixedLayoutView : function(view) {
                return view.referencePropertyList[1].value == "left-fixed";
            },

            _isTabLayoutView : function(view) {
                return view.referencePropertyList[1].value == "tab";
            },

            _isRightFixedLayoutView : function(view) {
                return view.referencePropertyList[1].value == "right-fixed";
            },

            _isViewHidden : function(view) {
                return view.referencePropertyList[2].value == "true";
            },

            _viewStyle : function(view) {
                return this._viewWidth(view) + ";" + this._viewMargin(view);
            },

            _viewWidth : function(view) {
                var width = view.referencePropertyList.length > 3 ? view.referencePropertyList[3].value : "-1";
                return "width:" + (width != "-1" ? width + "%" : "100%");
            },

            _viewMargin : function(view) {
                var width = view.referencePropertyList.length > 3 ? view.referencePropertyList[3].value : "-1";
                return width != "-1" ? "margin:0 auto" : "";
            },

            _selectView : function(name) {
                var element = this.querySelector("paper-tab[name='" + name + "']");
                if (element == null) return;
                if (this.lastView == name) return;
                this.lastView = name;
                this._openView({ detail : element.view.name });
            }

        });
    </script>
</dom-module>