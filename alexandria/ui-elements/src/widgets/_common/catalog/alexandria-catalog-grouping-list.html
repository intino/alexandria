<link rel="import" href="../../../../lib/polymer/polymer.html">
<link rel="import" href="../../../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../../../../lib/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../lib/iron-icons/iron-icons.html">
<link rel="import" href="../../../../lib/cotton-checkbox/cotton-checkbox.html">
<link rel="import" href="../../../../lib/cotton-cookies/cotton-cookies.html">
<link rel="import" href="alexandria-catalog-grouping.html">

<script src="../../../../lib/cotton-cookies/cookies.js"></script>

<dom-module id="alexandria-catalog-grouping-list">

    <template>
        <cotton-cookies language="[[_language]]" theme="light-top"></cotton-cookies>

        <div id="toolbar" class="toolbar layout horizontal end-justified">
            <cotton-checkbox checked="{{_checked}}" on-change="_toggleCharts">[[_toggleChartsLabel]]</cotton-checkbox>
        </div>
        <ul class="groupings">
            <template is="dom-if" if="[[!groupingList.length]]">
                <li class="empty layout vertical center center-justified">[[NoGroupings]]</li>
            </template>
            <template is="dom-repeat" items="[[groupingList]]" as="grouping">
                <li class="grouping">
                    <paper-icon-button icon="icons:check"></paper-icon-button>
                    <alexandria-catalog-grouping grouping$="[[grouping]]" on-selection-change="_handleGroupingChange"></alexandria-catalog-grouping>
                </li>
            </template>
        </ul>
    </template>

    <style>
        :host {
            border-right: 1px solid #ddd;
        }
        :host .toolbar {
            background: #efefef;
            padding: 8px;
        }
        :host cotton-checkbox {
            --cotton-checkbox-size : 14px;
            font-size: 10pt;
        }
        :host .groupings {
            margin: 0;
            padding: 0;
            border: 0;
            width: 300px;
            min-width: 300px;
            height: calc(100% - 31px);
            overflow: auto;
            @apply(--grouping-list);
        }
        :host .groupings .grouping {
            border-bottom: 1px solid #ddd;
            padding: 0;
            cursor: pointer;
            position: relative;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
        }
        :host .groupings .grouping paper-icon-button {
            position: absolute;
            top: 0;
            right: 0;
            display: none;
        }
        :host .groupings .grouping alexandria-catalog-grouping {
            border: 3px solid white;
            height: calc(100% - 26px);
            width: calc(100% - 26px);
            display: inline-block;
            padding: 10px;
        }
        :host .groupings .empty {
            height: 100%;
            font-size: 20px;
        }
    </style>

    <script>
        const AlexandriaCatalogGroupingListDictionary = {
            es: {
                NoGroupings : "No hay agrupaciones",
                ShowCharts : "mostrar histogramas",
                HideCharts : "ocultar histogramas"
            },
            en: {
                NoGroupings : "No groupings available",
                ShowCharts : "show histograms",
                HideCharts : "hide histograms"
            }
        };

        Polymer({
            is: 'alexandria-catalog-grouping-list',

            properties: {
                groupingList: { type: Object, value: function() { return []; }, observer: '_refreshDelayed' },
                histogramsMode : { type: String, observer: '_refreshHistogramsMode' },
                _language: String,
                _toggleChartsLabel : String,
                _checked : { type: Boolean, value: function() { return true; } }
            },

            behaviors: [CottonBehaviors.TranslatorBehavior],

            attached: function () {
                this.translate(AlexandriaCatalogGroupingListDictionary);
                this._language = this.getLanguage();
                this._load();
            },

            _load : function() {
                var showCharts = true;
                try {
                    var value = Cookies.get("alexandria-catalog-groupings-charts");
                    showCharts = value == null || (value != null && value === "true") ? true : false;
                }
                catch (exception) {
                }
                this._checked = showCharts;
            },

            _handleGroupingChange : function(event) {
                var groupingElement = event.target;
                var grouping = groupingElement.grouping;
                this.fire('grouping-selection-change', { name: grouping.name, groups: groupingElement.getSelectedGroups() });
            },

            _toggleCharts : function() {
                this._checked = !this._checked;
                try {
                    Cookies.set("alexandria-catalog-groupings-charts", this._checked.toString(), 30);
                }
                catch (exception) {
                }
                this._refresh();
            },

            _refreshDelayed : function() {
                window.setTimeout(() => this._refresh(), 100);
            },

            _refreshHistogramsMode : function () {
                var mode = this.histogramsMode;

                if (mode === "Disabled") {
                    this.$.toolbar.hidden = true;
                    return;
                }

                this.$.toolbar.hidden = false;
                if (Cookies.get("alexandria-catalog-groupings-charts") != null) return;
                this._checked = mode === "EnabledAndVisible";
            },

            _refresh : function() {
                this.querySelectorAll("alexandria-catalog-grouping").forEach((grouping) => {
                    if (this._checked) grouping.showCharts();
            else grouping.hideCharts();
            });
                this._toggleChartsLabel = this._checked ? this.HideCharts : this.ShowCharts;
            }

        });
    </script>

</dom-module>
