<link rel="import" href="../../../../lib/polymer/polymer.html">
<link rel="import" href="../../../../lib/cotton-translator/cotton-translator-behavior.html">
<link rel="import" href="../../../../lib/cotton-checkbox/cotton-checkbox.html">
<link rel="import" href="../../../../lib/paper-input/paper-input.html">
<link rel="import" href="../../../../lib/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../lib/iron-icons/iron-icons.html">
<link rel="import" href="../../../../lib/iron-icons/av-icons.html">
<link rel="import" href="../../../../lib/iron-icon/iron-icon.html">
<link rel="import" href="alexandria-group-chart.html">

<dom-module id="alexandria-catalog-grouping">

    <template>
        <!--<div class="label layout horizontal end-justified"><cotton-checkbox checked id="groupsCheckbox" disabled$="[[_groupsDisabled]]" icon="av:stop" on-change="_toggleGroups">[[_grouping.label]]</cotton-checkbox></div>-->
        <div class="label layout horizontal">
            <div>[[_grouping.label]]</div>
            <div hidden$="[[!_allSelected]]">[[UnSelectAll]]</div>
        </div>
        <div class="toolbar" hidden$="[[!_enoughGroups]]">
            <paper-input id="filterInput" noLabelFloat placeholder="[[Filter]]" on-keyup="_keyUp"><iron-icon icon="search" suffix></iron-icon></paper-input>
            <div class="layout horizontal end-justified info" hidden$="[[!_selectedCount]]"><div class="count">[[_selectedCount]]</div>&nbsp;/&nbsp;<div class="total">[[_count]]</div></div>
        </div>
        <ul id="groups" class="groups collapsed">
            <li class="message" hidden$="[[_grouping.groupList.length]]">[[NoGroups]]</li>
            <template is="dom-if" if="[[!someGroupsVisible]]">
                <li class="message">[[NoGroups]]</li>
            </template>
            <template is="dom-repeat" items="[[_grouping.groupList]]" as="group">
                <li name$="_[[group.idx]]" class$="layout horizontal group expanded_[[group.expanded]]">
                    <div class="chart"><alexandria-group-chart group="[[group]]" percentage="[[_grouping.isPercentage]]" count="[[_grouping.countItems]]" color="[[group.color]]"></alexandria-group-chart></div>
                    <div class="layout horizontal flex">
                        <cotton-checkbox disabled$="[[_groupsDisabled]]" class="flex" name$="[[group.label]]" icon="av:stop" checked$="[[group.selected]]" on-change="_toggleGroup">[[group.label]]</cotton-checkbox>
                        <paper-icon-button group$="[[group.name]]" icon="clear" on-tap="_deleteGroup" hidden></paper-icon-button>
                    </div>
                </li>
            </template>
            <a id="showAll" on-tap="_allGroups" class="show-all" hidden$="[[!_enoughGroups]]">[[ShowAll]]</a>
        </ul>
    </template>

    <style>
        :host {
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
        }
        :host .label {
            font-weight: bold;
            font-size: 11pt;
        }
        :host .label, :host .toolbar {
            margin-left: 92px;
        }
        :host.no-charts .label, :host.no-charts .toolbar {
            margin-left: 22px;
        }
        :host.no-charts .chart {
            display: none;
        }
        :host paper-input {
            --paper-input-container : {
                padding: 5px 0;
            };
            --paper-input-container-input : {
                font-size: 10pt;
            };
            --paper-input-container-label : {
                display: none;
            }
        }
        :host paper-input ::content .floated-label-placeholder {
            display: none;
        }
        :host paper-input iron-icon {
            height: 16px;
        }
        :host .info {
            font-size: 8pt;
            color: var(--secondary-text-color);
        }
        :host .chart {
            width: 65px;
            margin-right: 5px;
        }
        :host .groups {
            margin: 5px 0 0;
            padding: 0;
            list-style: none;
            font-size: 10pt;
        }
        :host .groups.collapsed .expanded_true {
            display: none;
        }
        :host .groups .expanded_true {
            display: flex;
        }
        :host .groups li {
            margin-bottom: 3px;
        }
        :host .groups .show-all {
            margin-top: 5px;
            margin-left: 21px;
            display: block;
            margin-bottom: 10px;
            color: var(--default-primary-color);
            cursor: pointer;
        }
        :host .message {
            text-align: center;
        }
        :host cotton-checkbox {
            --cotton-checkbox-size : 14px;
        }
        :host paper-icon-button {
            height: 15px;
            width: 15px;
            padding: 0;
            display: none;
        }
        :host .group:hover paper-icon-button {
            display: block;
        }
    </style>

    <script>
        const AlexandriaCatalogGroupingDictionary = {
            es: {
                Filter : "filtrar",
                NoGroups : "no hay opciones",
                ShowAll : "mostrar todos"
            },
            en: {
                Filter : "filter",
                NoGroups : "no options",
                ShowAll : "show all"
            }
        };

        const AlexandriaCatalogGroupingGroupColorEnabled = "#499A00";
        const AlexandriaCatalogGroupingGroupColorDisabled = "#ddd";
        const AlexandriaCatalogGroupingMaxItems = 10;

        Polymer({
            is: 'alexandria-catalog-grouping',

            properties: {
                grouping: { type: Object, observer: '_refreshGrouping' },
                _grouping: Object,
                someGroupsVisible: Boolean,
                _count: Number,
                _selectedCount: Number,
                _enoughGroups: Boolean,
                _groupsDisabled: Boolean,
                _chartsVisible : Boolean,
                _allSelected : Boolean,
                _showAll : { type: Boolean, value: function() { return false; } }
            },

            behaviors: [CottonBehaviors.TranslatorBehavior],

            attached: function () {
                this.translate(AlexandriaCatalogGroupingDictionary);
            },

            getSelectedGroups : function() {
                var result = [];
                this.querySelectorAll(".groups cotton-checkbox").forEach((checkbox) => {
                    if (checkbox.checked) result.push(checkbox.getAttribute("name"));
            });
                return result;
            },

            showCharts : function() {
                $(this).removeClass("no-charts");
            },

            hideCharts : function() {
                $(this).addClass("no-charts");
            },

            _colorOf : function(group) {
                return group.selected ? AlexandriaCatalogGroupingGroupColorEnabled : AlexandriaCatalogGroupingGroupColorDisabled;
            },

            _refreshGrouping : function() {
                let count = this.grouping.groupList.length;
                this._refreshInternalGrouping();
                this._groupsDisabled = count == 1;
                this._enoughGroups = count > AlexandriaCatalogGroupingMaxItems;
                this._selectedCount = this.getSelectedGroups().length;
                this._count = count;
                window.setTimeout(() => {
                    if (this.$.filterInput.value === "") return;
                this._filter();
            }, 100);
            },

            _refreshInternalGrouping : function() {
                this.notifyPath("_grouping", { name: this.grouping.name,
                    countItems: this.grouping.countItems,
                    label: this.grouping.label,
                    isPercentage: this._isPercentage(),
                    groupList: [] });
                window.setTimeout(() => {
                    var groups = this.grouping.groupList;
                for (var i=0; i<groups.length; i++) {
                    var group = groups[i];
                    group.idx = this._groupIdx(group.label);
                    group.expanded = i > AlexandriaCatalogGroupingMaxItems;
                    group.color = this._colorOf(group);
                }
                this.notifyPath("_grouping.groupList", groups);
            }, 50);
            },

            _refreshGroupsCheckbox : function() {
                var allSelected = true;
                let checkboxes = this.querySelectorAll(".groups cotton-checkbox");
                for (var i=0;i<checkboxes.length; i++) {
                    if (!checkboxes[i].checked) {
                        allSelected = false;
                        break;
                    }
                }
                //this.$.groupsCheckbox.checked = allSelected;
            },

            _toggleGroups : function(event) {
                return;
//                let value = this.$.groupsCheckbox.checked;
//                this.querySelectorAll(".groups cotton-checkbox").forEach((checkbox) => {
//                    checkbox.checked = value;
//                });
//                this.fire("selection-change");
            },

            _toggleGroup : function(event) {
                if (this.timer) window.clearTimeout(this.timer);
                this.timer = window.setTimeout(() => this.fire("selection-change"), 600);
                this._refreshColor(event);
                this._selectedCount = this.getSelectedGroups().length;
                this._refreshGroupsCheckbox();
            },

            _refreshColor : function(event) {
                var container = $(event.target).parents("li").get(0);
                var groupChart = container.querySelector("alexandria-group-chart");
                var checked = container.querySelector("cotton-checkbox").checked;
                groupChart.color = checked ? AlexandriaCatalogGroupingGroupColorEnabled : AlexandriaCatalogGroupingGroupColorDisabled;
            },

            _isPercentage : function() {
                return this.grouping.histogram.toLowerCase() === "percentage";
            },

            _groupIdx : function(label) {
                return label.normalize('NFD').replace(/[\W_]+/g,"").replace(/[\u0300-\u036f]/g, "");
            },

            _filter : function() {
                var value = this._groupIdx(this.$.filterInput.value).toLowerCase();
                var countValidGroups = 0;
                var showAll = this._showAll;
                this.querySelectorAll(".group").forEach(function(group) {
                    var name = group.getAttribute("name");
                    let valid = value === "" || name.toLowerCase().indexOf(value) !== -1;
                    if (valid) countValidGroups++;
                    group.expanded = valid && !showAll && countValidGroups > AlexandriaCatalogGroupingMaxItems;
                    group.style.display = valid && !group.expanded ? "flex" : "none";
                });
                if (!this._showAll) $(this.$.groups).addClass("collapsed");
                if (!this._showAll && countValidGroups > AlexandriaCatalogGroupingMaxItems) this._showAllGroups();
                else this._hideAllGroups();
                this.someGroupsVisible = countValidGroups > 0;
            },

            _keyUp : function() {
                this._showAll = false;
                this._filter();
            },

            _isDisabled : function() {
                return this.grouping.groupList.length <= 1;
            },

            _deleteGroup : function(e) {
                var target = e.target;
                var group = target.getAttribute("group") != null ? target.getAttribute("group") : $(target).parent("paper-icon-button").get(0).getAttribute("group");
                this.fire("delete-grouping-group", { grouping: this.grouping.name, name: group });
            },

            _allGroups : function(e) {
                $(this.$.groups).removeClass("collapsed");
                this._showAll = true;
                this._hideAllGroups();
                this._filter();
            },

            _showAllGroups : function() {
                this.$.showAll.hidden = false;
            },

            _hideAllGroups : function() {
                this.$.showAll.hidden = true;
            }

        });
    </script>

</dom-module>
