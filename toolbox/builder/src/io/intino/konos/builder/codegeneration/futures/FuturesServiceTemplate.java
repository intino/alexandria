package io.intino.konos.builder.codegeneration.futures;

import io.intino.itrules.RuleSet;
import io.intino.itrules.Template;

public class FuturesServiceTemplate extends Template {

	public RuleSet ruleSet() {
		return new RuleSet().add(
			rule().condition((type("service"))).output(literal("package ")).output(mark("package", "ValidPackage")).output(literal(";\n\nimport ")).output(mark("package", "validPackage")).output(literal(".")).output(mark("box", "snakecaseToCamelCase", "firstUpperCase")).output(literal("Box;\nimport io.intino.alexandria.http.AlexandriaSpark;\nimport io.intino.alexandria.logger.Logger;\nimport io.intino.alexandria.scheduler.AlexandriaScheduler;\nimport org.apache.commons.io.FileUtils;\n")).output(mark("schemaImport")).output(literal("\nimport org.quartz.*;\n\nimport java.io.File;\nimport java.io.IOException;\nimport java.nio.file.Files;\nimport java.time.Instant;\nimport java.time.temporal.ChronoUnit;\nimport java.util.*;\nimport java.util.function.Predicate;\nimport java.util.stream.Collectors;\n\nimport static io.intino.alexandria.Json.fromString;\nimport static org.quartz.CronScheduleBuilder.cronSchedule;\nimport static org.quartz.JobBuilder.newJob;\nimport static org.quartz.TriggerBuilder.newTrigger;\n\n@SuppressWarnings(\"unchecked\")\npublic class FuturesService {\n\tpublic static final String BasePath = \"")).output(mark("basePath")).output(literal("/\";\n\tprivate static final Map<String, File> sources = new HashMap<>();\n\tprivate static final Map<String, Instant> timeouts = new HashMap<>();\n\tprivate final TrooperBox box;\n\tprivate final File root;\n\n\tpublic FuturesService(TrooperBox box) {\n\t\tthis.box = box;\n\t\tthis.root = box.archetype().futures().root();\n\t}\n\n\t")).output(mark("future", "getter").multiple("\n\n")).output(literal("\n\n\t")).output(mark("future", "execute").multiple("\n\n")).output(literal("\n\n\tpublic AlexandriaSpark<?> setup(AlexandriaSpark<?> server, AlexandriaScheduler scheduler) {\n\t\tloadFutures();\n\t\tstartTimers(scheduler);\n\t\tstartService(server);\n\t\treturn server;\n\t}\n\n\tpublic Create create() {\n\t\treturn new Create();\n\t}\n\n\tprivate void startTimers(AlexandriaScheduler scheduler) {\n\t\ttry {\n\t\t\tJobDetail job = newJob(FuturesServiceTrigger.class).withIdentity(\"FuturesServiceTrigger\").build();\n\t\t\tjob.getJobDataMap().put(\"box\", box);\n\t\t\tscheduler.scheduleJob(job, Set.of(newTrigger().withIdentity(\"FutureServiceTrigger\").withSchedule(cronSchedule(\"* * * 1/1 * ? *\")).build()), true);\n\t\t} catch (SchedulerException e) {\n\t\t\tLogger.error(e);\n\t\t}\n\t}\n\n\tprivate void startService(AlexandriaSpark<?> server) {\n\t\t")).output(mark("future", "route").multiple("\n")).output(literal("\n\t}\n\n\t")).output(mark("future", "register").multiple("\n")).output(literal("\n\n\tprivate void loadFutures() {\n\t\t")).output(mark("future", "load").multiple("\n")).output(literal("\n\t}\n\n\t")).output(mark("future", "private").multiple("\n")).output(literal("\n\n\tprivate static String read(File file) {\n\t\ttry {\n\t\t\treturn Files.readString(file.toPath());\n\t\t} catch (IOException e) {\n\t\t\tLogger.error(e);\n\t\t\treturn \"\";\n\t\t}\n\t}\n\n\tpublic class Create {\n\t\t")).output(mark("future", "createMethod").multiple("\n\n")).output(literal("\n\n\t\t")).output(mark("future", "createClass").multiple("\n\n")).output(literal("\n\t}\n\n\tpublic static class Option {\n\t\tString id = UUID.randomUUID().toString();\n\t}\n\n\tprivate static class FuturesServiceTrigger implements Job {\n\n\t\tpublic void execute(JobExecutionContext context) throws JobExecutionException {\n\t\t\tTrooperBox box = (TrooperBox) context.getMergedJobDataMap().get(\"box\");\n\t\t\tfinal Instant instant = Instant.now().truncatedTo(ChronoUnit.SECONDS);\n\t\t\ttimeouts.forEach((k, v) -> {\n\t\t\t\tif (v.equals(instant)) {\n\t\t\t\t\t")).output(mark("future", "timeout").multiple("\n")).output(literal("\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n}")),
			rule().condition((trigger("register"))).output(literal("private void register")).output(mark("name", "firstUpperCase")).output(literal("(")).output(mark("name", "firstUpperCase")).output(literal("Schema schema) {\n\tregister(schema, ")).output(mark("name", "firstLowerCase")).output(literal("File(")).output(mark("parameter", "schemaParameter").multiple(", ")).output(literal("));\n}\n\nprivate static void register(")).output(mark("name", "firstUpperCase")).output(literal("Schema schema, File file) {\n\t")).output(mark("option", "putOption").multiple("\n")).output(literal("\n\ttimeouts.put(\"")).output(mark("name", "firstUpperCase")).output(literal("#\" + schema.timeout().id, schema.timeout().timeout);\n}")),
			rule().condition((trigger("load"))).output(mark("name", "firstLowerCase")).output(literal("Files().forEach(file -> register(fromString(read(file), ")).output(mark("name", "firstUpperCase")).output(literal("Schema.class), file));")),
			rule().condition((trigger("route"))).output(literal("server.route(BasePath + Abstract")).output(mark("name", "firstUpperCase")).output(literal(".URI.Path + \":id\").post(manager -> execute")).output(mark("name", "firstUpperCase")).output(literal("(manager.fromPath(\"id\")));")),
			rule().condition((trigger("ifoption"))).output(literal("if (\"")).output(mark("name")).output(literal("\".equals(option)) schema.")).output(mark("name")).output(literal("();")),
			rule().condition((trigger("putoption"))).output(literal("sources.put(schema.")).output(mark("name")).output(literal("().id, file);")),
			rule().condition((trigger("private"))).output(literal("private Collection<File> ")).output(mark("name", "firstLowerCase")).output(literal("Files() {\n\treturn FileUtils.listFiles(new File(root, \"")).output(mark("name", "camelCaseToSnakeCase")).output(literal("/\"), new String[]{\"json\"}, true);\n}\n\nprivate File ")).output(mark("name", "firstLowerCase")).output(literal("File(")).output(mark("parameter", "signature").multiple(", ")).output(literal(") {\n\treturn new File(root, \"")).output(mark("name", "camelCaseToSnakeCase")).output(literal("/\" + ")).output(mark("parameter", "name").multiple(" + \".\" + ")).output(literal(" + \".json\");\n}\n\nprivate ")).output(mark("name", "firstUpperCase")).output(literal(" ")).output(mark("name", "firstLowerCase")).output(literal("(File file) {\n\tfinal ")).output(mark("name", "firstUpperCase")).output(literal(" future = new ")).output(mark("name", "firstUpperCase")).output(literal("(box);\n\tfuture.schema = fromString(read(file), ")).output(mark("name", "firstUpperCase")).output(literal("Schema.class);\n\treturn future;\n}\n")),
			rule().condition((trigger("execute"))).output(literal("public void execute")).output(mark("name", "firstUpperCase")).output(literal("(String id) {\n\tfinal File file = sources.get(id);\n\tif (file == null) return;\n\tfinal ")).output(mark("name", "firstUpperCase")).output(literal(" schema = ")).output(mark("name", "firstLowerCase")).output(literal("(file);\n\tfinal String option = schema.uri().option(id);\n\tif (option == null) return;\n\t")).output(mark("option", "ifOption").multiple("\n else ")).output(literal("\n\tschema.uri().ids().forEach(sources::remove);\n\tfile.delete();\n}")),
			rule().condition((trigger("getter"))).output(literal("public List<")).output(mark("name", "firstUpperCase")).output(literal("> all")).output(mark("name", "firstUpperCase")).output(literal("(")).output(mark("parameter", "predicateSignature").multiple(", ")).output(literal(") {\n\treturn ")).output(mark("name", "firstLowerCase")).output(literal("Files().stream()\n\t\t\t.filter(f -> ")).output(mark("parameter", "test").multiple("&&")).output(literal("))\n\t\t\t.map(this::")).output(mark("name", "firstLowerCase")).output(literal(").collect(Collectors.toList());\n}\n\npublic ")).output(mark("name", "firstUpperCase")).output(literal(" ")).output(mark("name", "firstLowerCase")).output(literal("(")).output(mark("parameter", "signature").multiple(", ")).output(literal(") {\n\treturn ")).output(mark("name", "firstLowerCase")).output(literal("(")).output(mark("name", "firstLowerCase")).output(literal("File(")).output(mark("parameter", "name").multiple(", ")).output(literal("));\n}")),
			rule().condition((trigger("createmethod"))).output(literal("public ")).output(mark("name", "firstUpperCase")).output(literal(" ")).output(mark("name", "firstLowerCase")).output(literal("(")).output(mark("parameter", "signature").multiple(", ")).output(literal(") {\n\treturn new ")).output(mark("name", "firstUpperCase")).output(literal("(")).output(mark("parameter", "name").multiple(", ")).output(literal(");\n}")),
			rule().condition((trigger("timeout"))).output(literal("if (k.startsWith(\"")).output(mark("name", "FirstUpperCase")).output(literal("#\")) box.futuresService().execute")).output(mark("name", "FirstUpperCase")).output(literal("(k.split(\"#\")[1]);")),
			rule().condition((trigger("predicatesignature"))).output(literal("Predicate<")).output(mark("type")).output(literal("> ")).output(mark("name")),
			rule().condition((trigger("signature"))).output(mark("type")).output(literal(" ")).output(mark("name")),
			rule().condition((trigger("name"))).output(mark("name")),
			rule().condition((trigger("test"))).output(mark("name")).output(literal(".test(f.getName().split(\"\\.\")[")).output(mark("index")).output(literal("])")),
			rule().condition((trigger("schemaparameter"))).output(literal("schema.")).output(mark("name")),
			rule().condition((trigger("fluid"))).output(literal(".")).output(mark("name", "firstLowerCase")).output(literal("(")).output(mark("name", "firstLowerCase")).output(literal(")")),
			rule().condition((trigger("optioncreate"))).output(literal("public ")).output(mark("future", "firstUpperCase")).output(literal("(")).output(mark("parameter", "signature").multiple(", ")).output(literal(") {\n\tschema.reject(new ")).output(mark("future", "firstUpperCase")).output(literal("Schema.Reject(")).output(mark("parameter", "name").multiple(", ")).output(literal("));\n\treturn this;\n}")),
			rule().condition((trigger("createclass"))).output(literal("public class ")).output(mark("name", "firstUpperCase")).output(literal(" {\n\tprivate final ")).output(mark("name", "firstUpperCase")).output(literal("Schema schema;\n\n\tpublic ")).output(mark("name", "firstUpperCase")).output(literal("(")).output(mark("parameter", "signature").multiple(", ")).output(literal(") {\n\t\tschema = new ")).output(mark("name", "firstUpperCase")).output(literal("Schema()")).output(mark("parameter", "fluid").multiple(".")).output(literal(";\n\t}\n\n\t")).output(mark("option", "optionCreate").multiple("\n")).output(literal("\n\n\tpublic ")).output(mark("name", "firstUpperCase")).output(literal(" timeout(Instant timeout) {\n\t\tschema.timeout(new ")).output(mark("name", "firstUpperCase")).output(literal("Schema.Timeout(timeout.truncatedTo(ChronoUnit.SECONDS)));\n\t\treturn this;\n\t}\n\n\tpublic void save() {\n\t\tregister")).output(mark("name", "firstUpperCase")).output(literal("(schema);\n\t}\n}")),
			rule().condition((type("schemaImport"))).output(literal("import ")).output(mark("package")).output(literal(".schemas.*;"))
		);
	}
}