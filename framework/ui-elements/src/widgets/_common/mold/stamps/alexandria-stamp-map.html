<link rel="import" href="../../../../../lib/polymer/polymer.html">
<link rel="import" href="../../../../../lib/google-map/google-map.html">
<link rel="import" href="alexandria-stamp-behavior.html">
<link rel="import" href="alexandria-stamp-map-item.html">

<dom-module id="alexandria-stamp-map">

    <template>
        <google-map map="{{map}}"
                    additional-map-options="[[_options]]"
                    latitude="[[_latitude]]"
                    longitude="[[_longitude]]"
                    min-zoom="[[_zoom]]"
                    zoom="[[_zoom]]"
                    max-zoom="[[_zoom]]"
                    api-key="[[_googleApiKey]]"
                    fit-to-markers="true"
                    disable-map-type-control="true"
                    disable-default-ui
                    disable-street-view-control="true"></google-map>

        <alexandria-stamp-map-item value="[[_marker]]" drawing-color="black"></alexandria-stamp-map-item>
    </template>

    <style>
        :host google-map {
            width: 100%;
            height: 100%;
        }
    </style>

    <script>
        Polymer({
            is: 'alexandria-stamp-map',

            behaviors: [ AlexandriaBehaviors.StampBehavior ],

            properties : {
                map: Object,
                _marker : { type: String, value: function() { return null; } },
                _zoom : Number,
                _latitude : Number,
                _longitude : Number,
                _googleApiKey: { type: String, value: function() { return window.Application.configuration.googleApiKey; } }
            },

            attached: function () {
                this._prepareMap();
            },

            _render : function() {
                var properties = this.stamp.properties;
                this._marker = this.stamp.value;
                this._zoom = properties.zoom;
                this._latitude = properties.latitude;
                this._longitude = properties.longitude;
                this._updateMap();
            },

            _prepareMap : function() {
                var element = this.querySelector("google-map");
                element.addEventListener('google-map-ready', (e) => this._updateMap());
            },

            _updateMap : function() {
                if (this._refreshTimeout != null)
                    window.clearTimeout(this._refreshTimeout);

                var mapContainer = this.querySelector("google-map");
                var map = mapContainer.map;
                if (map != null) map.closeInfoWindows = () => this.closeInfoWindows();

                this._refreshTimeout = window.setTimeout(() => this.querySelectorAll("alexandria-stamp-map-item").forEach((item) => item.setMap(map)), 100);
            }

        });
    </script>

</dom-module>
